<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Exo 2:300,300italic,400,400italic,700,700italic|Caveat:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zobinhuang.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":180,"display":"post","padding":10,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="MathJax &#x3D; {         tex: {             inlineMath: [[&#39;$&#39;,&#39;$&#39;], [&#39;\\(&#39;,&#39;\\)&#39;]],             displayMath: [[&#39;$$&#39;,&#39;$$&#39;], [&#39;\\[&#39;,&#39;\\]&#39;]],             processEscapes: true,             process">
<meta property="og:type" content="website">
<meta property="og:title" content="从理解 NVCC 到理解 How CUDA Runtime Works？">
<meta property="og:url" content="https://zobinhuang.github.io/sec_learning/Tech_OS_And_Linux_Kernel/CUDA_NVCC_Compilation/index.html">
<meta property="og:site_name" content="Zobin">
<meta property="og:description" content="MathJax &#x3D; {         tex: {             inlineMath: [[&#39;$&#39;,&#39;$&#39;], [&#39;\\(&#39;,&#39;\\)&#39;]],             displayMath: [[&#39;$$&#39;,&#39;$$&#39;], [&#39;\\[&#39;,&#39;\\]&#39;]],             processEscapes: true,             process">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zobinhuang.github.io/sec_learning/Tech_OS_And_Linux_Kernel/CUDA_NVCC_Compilation/pic/process_overview.png">
<meta property="og:image" content="https://zobinhuang.github.io/sec_learning/Tech_OS_And_Linux_Kernel/CUDA_NVCC_Compilation/pic/program_structure.png">
<meta property="og:image" content="https://zobinhuang.github.io/sec_learning/Tech_OS_And_Linux_Kernel/CUDA_NVCC_Compilation/pic/xxx.png">
<meta property="article:published_time" content="2024-09-05T09:29:09.697Z">
<meta property="article:modified_time" content="2023-10-05T08:39:20.800Z">
<meta property="article:author" content="Zhuobin Huang">
<meta property="article:tag" content="Zobin">
<meta property="article:tag" content="黄卓彬">
<meta property="article:tag" content="zobinHuang">
<meta property="article:tag" content="网络工程">
<meta property="article:tag" content="Networking Engineering">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zobinhuang.github.io/sec_learning/Tech_OS_And_Linux_Kernel/CUDA_NVCC_Compilation/pic/process_overview.png">

<link rel="canonical" href="https://zobinhuang.github.io/sec_learning/Tech_OS_And_Linux_Kernel/CUDA_NVCC_Compilation/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>从理解 NVCC 到理解 How CUDA Runtime Works？ | Zobin
</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Zobin" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zobin</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Lovin' Tech with Tea</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about-me">

    <a href="/sec_about/" rel="section"><i class="fa fa-user fa-fw"></i>About Me</a>

  </li>
        <li class="menu-item menu-item-library">

    <a href="/sec_learning/" rel="section"><i class="fa fa-duotone fa-book fa-fw"></i>Library</a>

  </li>
        <li class="menu-item menu-item-production">

    <a href="/sec_music/" rel="section"><i class="fa fa-music fa-fw"></i>Production</a>

  </li>
        <li class="menu-item menu-item-thoughts">

    <a href="/sec_thoughts/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Thoughts</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
  
  

          <div class="content page posts-expand">
            

    
    
    
    <div class="post-block" lang="en">
      <header class="post-header">

<h1 class="post-title" itemprop="name headline">从理解 NVCC 到理解 How CUDA Runtime Works？
</h1>

<div class="post-meta">
  
  <ul class="breadcrumb">
          
            <li><a href="/sec_learning/">SEC_LEARNING</a></li>
            <li><a href="/sec_learning/Tech_OS_And_Linux_Kernel/">TECH_OS_AND_LINUX_KERNEL</a></li>
          <li>CUDA_NVCC_COMPILATION</li>
        
  </ul>

</div>

</header>

      
      
      
      <div class="post-body">
          <head>
<!--导入样式表-->
<link rel="stylesheet" type="text/css" href="style/index.css">

<!--导入网页脚本-->
<script src="script/index.js"></script>

<!--支持伪代码显示-->
<script>
    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-chtml.js"
        integrity="sha256-3Fdoa5wQb+JYfEmTpQHx9sc/GuwpfC/0R9EpBki+mf8=" crossorigin>
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js">
</script>

<!--支持网页公式显示-->    
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>

<!--支持矩阵显示-->
<script type="text/javascript">
  run_maths = function() {
    if (document.querySelector('[class*="cmath"]') !== null) {
      if (typeof (mjax_path)=='undefined') { mjax_path='https://cdn.jsdelivr.net/npm/mathjax@2'; }
      if (typeof (mjax_config)=='undefined') { mjax_config='AM_CHTML'; }
      smjax = document.createElement ('script');
      smjax.setAttribute('src',`${mjax_path}/MathJax.js?config=${mjax_config}`);
      smjax.setAttribute('async',true);
      document.getElementsByTagName('head')[0].appendChild(smjax);
    }
  };
  if (document.readyState === 'loading') {  
    window.addEventListener('DOMContentLoaded', run_maths); 
  } else { 
    run_maths(); 
  }
</script>
</head>

<body onload="load_page()">

<!-- 导入 mermaid -->
<script src="script/mermaid.min.js"></script>
<script>mermaid.initialize({startOnLoad:true});</script>

<!-- 导入 chart.js -->
<script src="script/chart.min.js"></script>

<!-- 本文的 Metadata -->
<div id="metadata"></div>

<!-- Start your post here -->
<h2 class="title">TL;DR</h2>
<div class="div_learning_post">
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;现有的参考资料 <cite>blog_1</cite><cite>blog_2</cite><cite>blog_3</cite> 非常详细地记录了博主们分析 <code>nvcc</code> 的 CUDA 程序构建过程，但是我发现在我的平台上的编译过程和他们有些许出入，遂进行记录，我的平台参数如 <tableref>platform</tableref> 所示。在记录的过程中，我发现如果能对 CUDA 程序的构建过程有一个比较深入的了解，则也能辅助理解构建后的 CUDA 程序是如何利用 CUDA Runtime APIs 工作的，故形成了如标题所示的本文内容。

  <div class="table" title="平台参数" label="platform">
    <table>
      <tr>
        <th>部件</th>
        <th>参数/版本</th>
      </tr>
      <tr>
        <td>GPU</td>
        <td>NVIDIA GeForce RTX 4060 Laptop GPU</td>
      </tr>
      <tr>
        <td>CUDA Toolkit</td>
        <td>12.2</td>
      </tr>
      <tr>
        <td>NVIDIA Driver</td>
        <td>536.45</td>
      </tr>
      <tr>
        <td><code>nvcc</code></td>
        <td>V12.1.105</td>
      </tr>
    </table>
  </div>  

</div>

<h2 class="title">构建过程简介和程序准备</h2>
<div class="div_learning_post">
  <h3 class="title">CUDA 程序构建与 <code>nvcc</code></h3>

  <div class="img" title=" <ci class='ci_dark'>A</ci> CUDA 编译轨道 (CUDA Compilation Trajectory), <ci class='ci_dark'>B</ci> 链接与 <ci class='ci_dark'>C</ci> 运行时" label="nvcc_process_overview">
    <img src="./pic/process_overview.png" width="600px" />
  </div>

  <h4 class="title">CUDA 程序的编译与链接</h4>

  <div class="noteblock">
  推荐读者朋友先阅读我的另一篇文章：<a href="/sec_learning/Tech_OS_And_Linux_Kernel/Non_Archived_Segment_And_Section/index.html">Section 与 Segment：从 链接器 到 Runtime 的角度出发</a>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;CUDA 程序的构建过程可以分为两个阶段: <ci class="ci_dark">A</ci> 编译和 <ci class="ci_dark">B</ci> 链接，如 <imgref>nvcc_process_overview</imgref> 所示。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;在 <ci class="ci_dark">A</ci> 编译阶段，对于每一个 <code>.cu</code> 文件，一共可以分为 4 步处理: <ci class="ci_dark">1</ci> 首先将 <code>.cu</code> 文件进行 Host 侧的预处理，包括展开头文件内容，替换 <code><<<>>></code> 语法糖等；<ci class="ci_dark">2</ci> 随后还是针对原始 <code>.cu</code> 文件，进行 Device 侧的预处理，然后首先编译出 <code>.ptx</code> 文件，如果 <code>.cu</code> 文件中带有 Kernel 的相关定义，则在 <code>.ptx</code> 文件中就会出现对应的 PTX 程序；<ci class="ci_dark">3</ci> 随后基于 PTX 进行 SASS 的编译，并最终将 PTX 和 SASS 程序一起打包放入 <code>.fatbin</code> 文件中，后者实际上是一段 C 程序代码，其中用 C 结构体封装了已经被编译为二进制的程序；<ci class="ci_dark">4</ci> 最终进行一次编译 (i.e., <code>gcc -c</code> 指令)，将 Host 侧程序和已经被编译为 Device 二进制的程序一起，打包为一个待重定位文件 (i.e., <code>.o</code> 文件)。在 <code>nvcc</code> 的官方文档 <cite>nvcc_doc</cite> 中将上述编译流程定义为 <def>CUDA 编译轨道 (CUDA Compilation Trajectory)</def>。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;在 <ci class="ci_dark">B</ci> 链接阶段，TODO

  <h4 class="title">NVCC</h4>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;<code>nvcc</code> 在 NVIDIA 官方文档 <cite>nvcc_doc</cite> 中被定义为 CUDA Compiler Driver，其目的在于掩盖包含了多次程序分离、预处理、编译和合并的 <ci class="ci_dark">A</ci> 编译阶段以及 <ci class="ci_dark">B</ci> 链接阶段。<code>nvcc</code> 并不是一个编译器，它的功能可以视为根据用户传入的命令行参数，按照一定的顺序调用对应的编译器/链接器对程序进行构建的 wrapper，因此才被称为编译器驱动。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;就后文的观察来看，<code>nvcc</code> 调用的编译器包括:

  <ul>
    <li><code>gcc</code>: Host 侧程序的编译器，使用 <code>-E</code> 指令进行预处理；使用 <code>-c</code> 指令编译出待重定位文件；</li>
    <li><code>cicc</code>: Device 侧 PTX 程序的编译器，其是一个 LLVM-based Compiler <cite>cicc_zhihu</cite>，负责将 C/C++ 定义的 device function 转化为虚拟架构 PTX 程序；</li>
    <li><code>cudafe++</code>: 用于处理 <code>.cu</code> 文件中的 CUDA 语法糖 (e.g., <code><<<>>></code> 调用符号，<code>__global__</code> kernel 定义等)</li>
  </ul>

  <h4 class="title">理解 nvcc 的编译参数</h4>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;接着我们理解一下 <code>nvcc</code> 的编译参数 <cite>nvcc_param_tips</cite>。

  <div class="code_segment" label="nvcc_exp_1">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nvcc  main.cu gemm_kernel_1.cu gemm_kernel_2.cu help_function.cu  \</span><br><span class="line">      -<span class="built_in">arch</span>=compute_89                                            \</span><br><span class="line">      -code=compute_89,sm_89,sm_90                                \ </span><br><span class="line">      -o gemm_exe                                                 \</span><br><span class="line">      -rdc=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;就最常用的参数来说，<code>arch</code> 用于指定虚拟架构，<code>code</code> 用于指定 nvcc 最后将向编译产物 (i.e., cubin 文件) 中放入哪些程序。例如 <coderef>nvcc_exp_1</coderef> 所示的命令，则 <code>nvcc</code> 将以 <code>compute_89</code> 的 PTX 代码，编译出 <code>sm_89</code> 和 <code>sm_90</code> 的 SASS 代码，然后最终向 cubin 中放入 <ci class="ci_dark">1</ci> <code>compute_89</code> 的 PTX，以及 <ci class="ci_dark">2</ci> <code>sm_89</code> 和 <ci class="ci_dark">3</ci> <code>sm_90</code> 的 SASS 代码。

  <div class="code_segment" label="nvcc_exp_2">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nvcc  main.cu gemm_kernel_1.cu gemm_kernel_2.cu help_function.cu  \ </span><br><span class="line">      -gencode=<span class="built_in">arch</span>=compute_89,code=sm_89                         \</span><br><span class="line">      -gencode=<span class="built_in">arch</span>=compute_89,code=sm_90                         \</span><br><span class="line">      -gencode=<span class="built_in">arch</span>=compute_90,code=sm_90                         \</span><br><span class="line">      -gencode=<span class="built_in">arch</span>=compute_89,code=compute_89                    \</span><br><span class="line">      -gencode=<span class="built_in">arch</span>=compute_90,code=compute_90                    \</span><br><span class="line">      -o gemm_exe                                                 \</span><br><span class="line">      -rdc=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;有时候我们又希望编译产物中可以包含基于多种虚拟架构的 PTX 代码，以及他们编译出来的对应 SASS，此时我们可以使用 <code>gencode</code> 选项。如 <coderef>nvcc_exp_2</coderef> 所示，编译完成后，编译产物中将包括 <ci class="ci_dark">1</ci> 基于 <code>compute_89</code> 编译形成的 <code>sm_89</code> SASS 程序；<ci class="ci_dark">2</ci> 基于 <code>compute_89</code> 编译形成的 <code>sm_90</code> SASS 程序；<ci class="ci_dark">3</ci> 基于 <code>compute_90</code> 编译形成的 <code>sm_90</code> SASS 程序；<ci class="ci_dark">4</ci> <code>compute_89</code> PTX 程序和 <ci class="ci_dark">5</ci> <code>compute_90</code> PTX 程序。

  <div class="noteblock">
  <coderef>nvcc_exp_1</coderef> 和 <coderef>nvcc_exp_2</coderef> 中的 <code>-rdc=true</code> 参数用于使能 Relocatable Device Code，使得在编译的时候不需要将 <code>__device__</code> <code>__global__</code> <cite>nvidia_rdc</cite>
  </div>

  <h3 class="title">程序准备</h3>

  <div class="img" title="程序结构" label="program_structure">
    <img src="./pic/program_structure.png" width="100%" />
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;我们进行编译实验的 CUDA 程序结构如 <coderef>structure</coderef> 所示，它们之间的关系如 <imgref>program_structure</imgref> 所示。简而言之，我们在 <code>gemm_kernel_1.cu</code> 和 <code>gemm_kernel_2.cu</code> 中分别定义了 1 个 kernel，其中 <code>gemm_kernel_2.cu</code> 中定义的 kernel 调用了在 <code>help_function.cu</code> 中定义的 device function。另外我们还在 <code>gemm_kernel_cublas.cu</code> 中定义了一个函数，其使用了来自 cuBLAS 库 <cite>cublas_doc</cite> 的 APIs。程序的主线逻辑则位于 <code>main.cu</code> 中。

  <div class="code_segment" label="structure">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── gemm_kernel.cuh</span><br><span class="line">├── gemm_kernel_1.cu</span><br><span class="line">├── gemm_kernel_2.cu</span><br><span class="line">├── gemm_kernel_cublas.cu</span><br><span class="line">├── help_function.cu</span><br><span class="line">└── main.cu</span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;分析这 5 个文件的编译过程，对应 5 个验证目的:

  <div class="border">
    <ul>
      <li><code>main.cu</code>: launch kernel 的 <code><<<>>></code> 语法糖在编译过程中被转化为了什么？</li>
      <li><code>gemm_kernel_1.cu</code>: kernel 是怎么被编译的？kernel 是怎么被注册和调用的？</li>
      <li><code>gemm_kernel_2.cu</code>: 调用了位于其它 .cu 文件定义的 device funtion 的 kernel 是怎么被编译的？以及注册和调用的？</li>
      <li><code>gemm_kernel_cublas.cu</code>: 调用了第三方库 (e.g., cuBLAS <cite>cublas_doc</cite>) 的 .cu 文件是怎么被编译和链接的？</code>
      <li><code>help_function.cu</code>: device function 是怎么被编译的？</li>
    </ul>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;就具体文件内容来说，我们首先在 <code>help_function.cu</code> 中定义了一个 device function <code>get_flat_index</code>，如 <coderef>help_function_cu</coderef> 所示。

  <div class="code_segment" file="help_function.cu" label="help_function_cu">

  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gemm_kernel.cuh&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">__device__ <span class="type">int</span> <span class="title">get_flat_index</span><span class="params">(<span class="type">const</span> <span class="type">int</span> row_id, <span class="type">const</span> <span class="type">int</span> col_id, <span class="type">const</span> <span class="type">int</span> row_dim)</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> row_id * row_dim + col_id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;在 <code>gemm_kernel_1.cu</code> 和 <code>gemm_kernel_2.cu</code> 中，我们分别定义了一个用于 GEMM 计算的 kernel，程序分别如 <coderef>gemm_kernel_1_cu</coderef> 和 <coderef>gemm_kernel_2_cu</coderef> 所示。其中，<code>gemm_kernel_2.cu</code> 中定义的 kernel <code>gemm_kernel_2</code> 使用了 device function <code>get_flat_function</code>，而 <code>gemm_kernel_1.cu</code> 中定义的 kernel <code>gemm_kernel_1</code> 没有使用。

  <div class="code_segment" file="gemm_kernel_1.cu" label="gemm_kernel_1_cu">

  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gemm_kernel.cuh&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// aligned implementation</span></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">gemm_kernel_1</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">/* m*n */</span> <span class="type">const</span> <span class="type">int</span> *a, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">/* k*n */</span> <span class="type">const</span> <span class="type">int</span> *<span class="type">b_t</span>, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">/* m*k */</span> <span class="type">int</span> *c, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">int</span> m, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">int</span> n, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">int</span> k</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>&#123;</span><br><span class="line">  <span class="meta">#<span class="keyword">pragma</span> unroll</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=blockIdx.x*blockDim.x+threadIdx.x; i&lt;=m*k; i+=blockDim.x)&#123;</span><br><span class="line">    <span class="type">int</span> row_id = i/k;</span><br><span class="line">    <span class="type">int</span> col_id = i-k*row_id;</span><br><span class="line">    <span class="type">int</span> c_flat_index = row_id*m+col_id;</span><br><span class="line">  </span><br><span class="line">    c[c_flat_index] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> unroll</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;n; j++)&#123;</span><br><span class="line">      c[c_flat_index] += a[row_id*n+j]*<span class="type">b_t</span>[col_id*n+j]; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>

  <div class="code_segment" file="gemm_kernel_2.cu" label="gemm_kernel_2_cu">

  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gemm_kernel.cuh&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// misaligned implementation</span></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">gemm_kernel_2</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">/* m*n */</span> <span class="type">const</span> <span class="type">int</span> *a, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">/* n*k */</span> <span class="type">const</span> <span class="type">int</span> *b, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">/* m*k */</span> <span class="type">int</span> *c, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">int</span> m, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">int</span> n, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">int</span> k</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>&#123;</span><br><span class="line">  <span class="meta">#<span class="keyword">pragma</span> unroll</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=blockIdx.x*blockDim.x+threadIdx.x; i&lt;=m*k; i+=blockDim.x)&#123;</span><br><span class="line">    <span class="type">int</span> row_id = i/k;</span><br><span class="line">    <span class="type">int</span> col_id = i-k*row_id;</span><br><span class="line">    <span class="type">int</span> c_flat_index = <span class="built_in">get_flat_index</span>(<span class="comment">/* row_id */</span>row_id, <span class="comment">/* col_id */</span>col_id, <span class="comment">/* row_dim */</span>m);</span><br><span class="line"></span><br><span class="line">    c[c_flat_index] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> unroll</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;n; j++)&#123;</span><br><span class="line">      c[c_flat_index] += a[row_id*n+j]*b[j*n+col_id]; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;在 <code>gemm_kernel_cublas.cu</code> 中，我们则定义了一个函数，其调用了 cuBLAS 库的部分 APIs，具体文件内容如下：

  <div class="code_segment">

  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cuda_runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cublas_v2.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> M 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IDX2F(i,j,ld) ((((j)-1)*(ld))+((i)-1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gemm_kernel.cuh&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">void</span> <span class="title">modify</span> <span class="params">(cublasHandle_t handle, <span class="type">float</span> *m, <span class="type">int</span> ldm, <span class="type">int</span> n, <span class="type">int</span> p, <span class="type">int</span> q, <span class="type">float</span> alpha, <span class="type">float</span> beta)</span></span>&#123;</span><br><span class="line">    <span class="built_in">cublasSscal</span> (handle, n-q+<span class="number">1</span>, &amp;alpha, &amp;m[<span class="built_in">IDX2F</span>(p,q,ldm)], ldm);</span><br><span class="line">    <span class="built_in">cublasSscal</span> (handle, ldm-p+<span class="number">1</span>, &amp;beta, &amp;m[<span class="built_in">IDX2F</span>(p,q,ldm)], <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gemm_kernel_cublas</span><span class="params">()</span></span>&#123;</span><br><span class="line">  cudaError_t cudaStat;</span><br><span class="line">  cublasStatus_t stat;</span><br><span class="line">  cublasHandle_t handle;</span><br><span class="line">  <span class="type">int</span> i, j;</span><br><span class="line">  <span class="type">float</span>* devPtrA;</span><br><span class="line">  <span class="type">float</span>* a = <span class="number">0</span>;</span><br><span class="line">  a = (<span class="type">float</span> *)<span class="built_in">malloc</span> (M * N * <span class="built_in">sizeof</span> (*a));</span><br><span class="line">  <span class="keyword">if</span> (!a) &#123;</span><br><span class="line">      <span class="built_in">printf</span> (<span class="string">&quot;host memory allocation failed&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt;= N; j++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= M; i++) &#123;</span><br><span class="line">          a[<span class="built_in">IDX2F</span>(i,j,M)] = (<span class="type">float</span>)((i<span class="number">-1</span>) * N + j);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  cudaStat = <span class="built_in">cudaMalloc</span> ((<span class="type">void</span>**)&amp;devPtrA, M*N*<span class="built_in">sizeof</span>(*a));</span><br><span class="line">  <span class="keyword">if</span> (cudaStat != cudaSuccess) &#123;</span><br><span class="line">      <span class="built_in">printf</span> (<span class="string">&quot;device memory allocation failed&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  stat = <span class="built_in">cublasCreate</span>(&amp;handle);</span><br><span class="line">  <span class="keyword">if</span> (stat != CUBLAS_STATUS_SUCCESS) &#123;</span><br><span class="line">      <span class="built_in">printf</span> (<span class="string">&quot;CUBLAS initialization failed\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  stat = <span class="built_in">cublasSetMatrix</span> (M, N, <span class="built_in">sizeof</span>(*a), a, M, devPtrA, M);</span><br><span class="line">  <span class="keyword">if</span> (stat != CUBLAS_STATUS_SUCCESS) &#123;</span><br><span class="line">      <span class="built_in">printf</span> (<span class="string">&quot;data download failed&quot;</span>);</span><br><span class="line">      <span class="built_in">cudaFree</span> (devPtrA);</span><br><span class="line">      <span class="built_in">cublasDestroy</span>(handle);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">modify</span> (handle, devPtrA, M, N, <span class="number">2</span>, <span class="number">3</span>, <span class="number">16.0f</span>, <span class="number">12.0f</span>);</span><br><span class="line">  stat = <span class="built_in">cublasGetMatrix</span> (M, N, <span class="built_in">sizeof</span>(*a), devPtrA, M, a, M);</span><br><span class="line">  <span class="keyword">if</span> (stat != CUBLAS_STATUS_SUCCESS) &#123;</span><br><span class="line">      <span class="built_in">printf</span> (<span class="string">&quot;data upload failed&quot;</span>);</span><br><span class="line">      <span class="built_in">cudaFree</span> (devPtrA);</span><br><span class="line">      <span class="built_in">cublasDestroy</span>(handle);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">cudaFree</span> (devPtrA);</span><br><span class="line">  <span class="built_in">cublasDestroy</span>(handle);</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt;= N; j++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= M; i++) &#123;</span><br><span class="line">          <span class="built_in">printf</span> (<span class="string">&quot;%7.0f&quot;</span>, a[<span class="built_in">IDX2F</span>(i,j,M)]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span> (<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;我们把以上所有函数的函数声明放在了 <code>gemm_kernel.cuh</code> 中:

  <div class="code_segment" file="gemm_kernel.cuh">

  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __GEMM_KERNEL_CUH__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GEMM_KERNEL_CUH__</span></span><br><span class="line"></span><br><span class="line"><span class="function">__device__ <span class="type">int</span> <span class="title">get_flat_index</span><span class="params">(<span class="type">const</span> <span class="type">int</span> row_id, <span class="type">const</span> <span class="type">int</span> col_id, <span class="type">const</span> <span class="type">int</span> row_dim)</span></span>;</span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">gemm_kernel_1</span><span class="params">(<span class="type">const</span> <span class="type">int</span> *a, <span class="type">const</span> <span class="type">int</span> *<span class="type">b_t</span>, <span class="type">int</span> *c, <span class="type">const</span> <span class="type">int</span> m, <span class="type">const</span> <span class="type">int</span> n, <span class="type">const</span> <span class="type">int</span> k)</span></span>;</span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">gemm_kernel_2</span><span class="params">(<span class="type">const</span> <span class="type">int</span> *a, <span class="type">const</span> <span class="type">int</span> *b, <span class="type">int</span> *c, <span class="type">const</span> <span class="type">int</span> m, <span class="type">const</span> <span class="type">int</span> n, <span class="type">const</span> <span class="type">int</span> k)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gemm_kernel_cublas</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;在 <code>main.cu</code> 中，我们则完成了一个简单的 CUDA 程序的定义:

  <div class="code_segment" file="main.cu">

  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cuda.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gemm_kernel.cuh&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> m=<span class="number">64</span>, n=<span class="number">128</span>, k=<span class="number">32</span>;</span><br><span class="line">  <span class="type">int</span> *da = <span class="literal">NULL</span>, *db = <span class="literal">NULL</span>, *dc = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="type">int</span> *ha = <span class="literal">NULL</span>, *hb = <span class="literal">NULL</span>, *hc = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaMalloc</span>((<span class="type">void</span> **)&amp;da, m*n*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (da == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;GPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaMalloc</span>((<span class="type">void</span> **)&amp;db, n*k*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (db == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;GPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaMalloc</span>((<span class="type">void</span> **)&amp;dc, m*k*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (dc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;GPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ha = (<span class="type">int</span> *)<span class="built_in">malloc</span>(m*n*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (ha == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;m*n; i++)&#123;</span><br><span class="line">    ha[i] = <span class="built_in">rand</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hb = (<span class="type">int</span> *)<span class="built_in">malloc</span>(n*k*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (hb == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;n*k; i++)&#123;</span><br><span class="line">    hb[i] = <span class="built_in">rand</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hc = (<span class="type">int</span> *)<span class="built_in">malloc</span>(m*k*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (hc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaMemcpy</span>(da, ha, m*n*<span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyHostToDevice);</span><br><span class="line">  <span class="built_in">cudaMemcpy</span>(db, hb, n*k*<span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyHostToDevice);</span><br><span class="line"></span><br><span class="line">  gemm_kernel_1&lt;&lt;&lt;<span class="number">1</span>,<span class="number">256</span>&gt;&gt;&gt;(da, db, dc, m, n, k);</span><br><span class="line">  <span class="built_in">cudaMemcpy</span>(hc, dc, m*k*<span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyDeviceToHost);</span><br><span class="line"></span><br><span class="line">  gemm_kernel_2&lt;&lt;&lt;<span class="number">1</span>,<span class="number">256</span>&gt;&gt;&gt;(da, db, dc, m, n, k);</span><br><span class="line">  <span class="built_in">cudaMemcpy</span>(hc, dc, m*k*<span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyDeviceToHost);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">gemm_kernel_cublas</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaFree</span>(da); <span class="built_in">cudaFree</span>(db); <span class="built_in">cudaFree</span>(dc);</span><br><span class="line">  <span class="built_in">free</span>(ha); <span class="built_in">free</span>(hb); <span class="built_in">free</span>(hc);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>

  <h3 class="title">编译过程 Overview</h3>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;为了探究过程完整性，我们运行如 <coderef>expose_nvcc</coderef> 所示的指令，使 <code>nvcc</code> 暴露其编译过程:

  <div class="code_segment" label="expose_nvcc">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc main.cu gemm_kernel_1.cu gemm_kernel_2.cu -<span class="built_in">arch</span>=compute_89 -code=compute_89,sm_89,sm_90 --verbose -o gemm_exe</span><br></pre></td></tr></table></figure>
  </div>



  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;运行过后，我们可以获得如 <coderef>compile_output</coderef> 所示的输出。

  <div class="code_segment" label="compile_output">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">$ _NVVM_BRANCH_=nvvm</span><br><span class="line">$ _SPACE_= </span><br><span class="line">$ _CUDART_=cudart</span><br><span class="line">$ _HERE_=/usr/local/cuda-12.1/bin</span><br><span class="line">$ _THERE_=/usr/local/cuda-12.1/bin</span><br><span class="line">$ _TARGET_SIZE_=</span><br><span class="line">$ _TARGET_DIR_=</span><br><span class="line">$ _TARGET_DIR_=targets/x86_64-linux</span><br><span class="line">$ TOP=/usr/local/cuda-12.1/bin/..</span><br><span class="line">$ NVVMIR_LIBRARY_DIR=/usr/local/cuda-12.1/bin/../nvvm/libdevice</span><br><span class="line">$ LD_LIBRARY_PATH=/usr/local/cuda-12.1/bin/../lib:</span><br><span class="line">$ PATH=/usr/local/cuda-12.1/bin/../nvvm/bin:/usr/local/cuda-12.1/bin:/usr/local/cuda-12.1/nvvm/bin:/usr/local/cuda-12.1/bin:/usr/local/cuda-12.1/nvvm/bin:/usr/local/cuda-12.1/bin:/home/zobin/anaconda3/bin:/home/zobin/anaconda3/condabin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/usr/lib/wsl/lib:/mnt/c/Windows/system32:/mnt/c/Windows:/mnt/c/Windows/System32/Wbem:/mnt/c/Windows/System32/WindowsPowerShell/v1.0:/mnt/c/Windows/System32/OpenSSH:/mnt/c/Program Files (x86)/NVIDIA Corporation/PhysX/Common:/mnt/c/Program Files/NVIDIA Corporation/NVIDIA NvDLISR:/mnt/c/Program Files/Docker/Docker/resources/bin:/mnt/e/applications/git/Git/cmd:/mnt/e/applications/nodejs:/mnt/c/ProgramData/chocolatey/bin:/mnt/e/applications/win32yank-x64:/mnt/c/Users/85280/AppData/Local/Microsoft/WindowsApps:/mnt/e/applications/vscode/Microsoft VS Code/bin:/mnt/c/Users/85280/AppData/Roaming/npm:/home/zobin/Applications/vivado_2022/Vivado/2022.2/bin:/home/zobin/Applications/vivado_2022/Vivado/2022.2/bin</span><br><span class="line">$ INCLUDES=<span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>  </span><br><span class="line">$ LIBRARIES=  <span class="string">&quot;-L/usr/local/cuda-12.1/bin/../targets/x86_64-linux/lib/stubs&quot;</span> <span class="string">&quot;-L/usr/local/cuda-12.1/bin/../targets/x86_64-linux/lib&quot;</span></span><br><span class="line">$ CUDAFE_FLAGS=</span><br><span class="line">$ PTXAS_FLAGS=</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================== 处理 main.cu ==================</span></span><br><span class="line"><span class="comment"># 预处理 host 侧代码</span></span><br><span class="line">$ gcc -D__CUDA_ARCH_LIST__=890 -E -x c++ -D__CUDACC__ -D__NVCC__  <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>    -D__CUDACC_VER_MAJOR__=12 -D__CUDACC_VER_MINOR__=1 -D__CUDACC_VER_BUILD__=105 -D__CUDA_API_VER_MAJOR__=12 -D__CUDA_API_VER_MINOR__=1 -D__NVCC_DIAG_PRAGMA_SUPPORT__=1 -include <span class="string">&quot;cuda_runtime.h&quot;</span> -m64 <span class="string">&quot;main.cu&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-5_main.cpp4.ii&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 分离出 host 侧代码</span></span><br><span class="line">$ cudafe++ --c++17 --gnu_version=110400 --display_error_number --orig_src_file_name <span class="string">&quot;main.cu&quot;</span> --orig_src_path_name <span class="string">&quot;/home/zobin/projects/pos/test_cuda/main.cu&quot;</span> --allow_managed  --m64 --parse_templates --gen_c_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-6_main.cudafe1.cpp&quot;</span> --stub_file_name <span class="string">&quot;tmpxft_0000047f_00000000-6_main.cudafe1.stub.c&quot;</span> --gen_module_id_file --module_id_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-4_main.module_id&quot;</span> <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-5_main.cpp4.ii&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 预处理 device 侧代码</span></span><br><span class="line">$ gcc -D__CUDA_ARCH__=890 -D__CUDA_ARCH_LIST__=890 -E -x c++  -DCUDA_DOUBLE_MATH_FUNCTIONS -D__CUDACC__ -D__NVCC__  <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>    -D__CUDACC_VER_MAJOR__=12 -D__CUDACC_VER_MINOR__=1 -D__CUDACC_VER_BUILD__=105 -D__CUDA_API_VER_MAJOR__=12 -D__CUDA_API_VER_MINOR__=1 -D__NVCC_DIAG_PRAGMA_SUPPORT__=1 -include <span class="string">&quot;cuda_runtime.h&quot;</span> -m64 <span class="string">&quot;main.cu&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-17_main.cpp1.ii&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译出 PTX 和 插桩文件</span></span><br><span class="line">$ cicc --c++17 --gnu_version=110400 --display_error_number --orig_src_file_name <span class="string">&quot;main.cu&quot;</span> --orig_src_path_name <span class="string">&quot;/home/zobin/projects/pos/test_cuda/main.cu&quot;</span> --allow_managed   -<span class="built_in">arch</span> compute_89 -m64 --no-version-ident -ftz=0 -prec_div=1 -prec_sqrt=1 -fmad=1 --include_file_name <span class="string">&quot;tmpxft_0000047f_00000000-3_main.fatbin.c&quot;</span> -tused --module_id_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-4_main.module_id&quot;</span> --gen_c_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-6_main.cudafe1.c&quot;</span> --stub_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-6_main.cudafe1.stub.c&quot;</span> --gen_device_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-6_main.cudafe1.gpu&quot;</span>  <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-17_main.cpp1.ii&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-6_main.ptx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译出 cubin (SASS)</span></span><br><span class="line">$ ptxas -<span class="built_in">arch</span>=sm_90 -m64  <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-6_main.ptx&quot;</span>  -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-18_main.sm_90.cubin&quot;</span> </span><br><span class="line">$ ptxas -<span class="built_in">arch</span>=sm_89 -m64  <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-6_main.ptx&quot;</span>  -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-19_main.sm_89.cubin&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 PTX 和 SASS 合并成为 fatbin.c</span></span><br><span class="line">$ fatbinary -64 --cicc-cmdline=<span class="string">&quot;-ftz=0 -prec_div=1 -prec_sqrt=1 -fmad=1 &quot;</span> <span class="string">&quot;--image3=kind=elf,sm=90,file=/tmp/tmpxft_0000047f_00000000-18_main.sm_90.cubin&quot;</span> <span class="string">&quot;--image3=kind=elf,sm=89,file=/tmp/tmpxft_0000047f_00000000-19_main.sm_89.cubin&quot;</span> <span class="string">&quot;--image3=kind=ptx,sm=89,file=/tmp/tmpxft_0000047f_00000000-6_main.ptx&quot;</span> --embedded-fatbin=<span class="string">&quot;/tmp/tmpxft_0000047f_00000000-3_main.fatbin.c&quot;</span> </span><br><span class="line">$ <span class="built_in">rm</span> /tmp/tmpxft_0000047f_00000000-3_main.fatbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译出 host 目标文件</span></span><br><span class="line">$ gcc -D__CUDA_ARCH__=890 -D__CUDA_ARCH_LIST__=890 -c -x c++  -DCUDA_DOUBLE_MATH_FUNCTIONS <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>   -m64 <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-6_main.cudafe1.cpp&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-20_main.o&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># ================== 处理 gemm_kernel_1.cu ==================</span></span><br><span class="line"><span class="comment"># 预处理 host 侧代码</span></span><br><span class="line">$ gcc -D__CUDA_ARCH_LIST__=890 -E -x c++ -D__CUDACC__ -D__NVCC__  <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>    -D__CUDACC_VER_MAJOR__=12 -D__CUDACC_VER_MINOR__=1 -D__CUDACC_VER_BUILD__=105 -D__CUDA_API_VER_MAJOR__=12 -D__CUDA_API_VER_MINOR__=1 -D__NVCC_DIAG_PRAGMA_SUPPORT__=1 -include <span class="string">&quot;cuda_runtime.h&quot;</span> -m64 <span class="string">&quot;gemm_kernel_1.cu&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-9_gemm_kernel_1.cpp4.ii&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 分离出 host 侧代码</span></span><br><span class="line">$ cudafe++ --c++17 --gnu_version=110400 --display_error_number --orig_src_file_name <span class="string">&quot;gemm_kernel_1.cu&quot;</span> --orig_src_path_name <span class="string">&quot;/home/zobin/projects/pos/test_cuda/gemm_kernel_1.cu&quot;</span> --allow_managed  --m64 --parse_templates --gen_c_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-10_gemm_kernel_1.cudafe1.cpp&quot;</span> --stub_file_name <span class="string">&quot;tmpxft_0000047f_00000000-10_gemm_kernel_1.cudafe1.stub.c&quot;</span> --gen_module_id_file --module_id_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-8_gemm_kernel_1.module_id&quot;</span> <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-9_gemm_kernel_1.cpp4.ii&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 预处理 device 侧代码</span></span><br><span class="line">$ gcc -D__CUDA_ARCH__=890 -D__CUDA_ARCH_LIST__=890 -E -x c++  -DCUDA_DOUBLE_MATH_FUNCTIONS -D__CUDACC__ -D__NVCC__  <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>    -D__CUDACC_VER_MAJOR__=12 -D__CUDACC_VER_MINOR__=1 -D__CUDACC_VER_BUILD__=105 -D__CUDA_API_VER_MAJOR__=12 -D__CUDA_API_VER_MINOR__=1 -D__NVCC_DIAG_PRAGMA_SUPPORT__=1 -include <span class="string">&quot;cuda_runtime.h&quot;</span> -m64 <span class="string">&quot;gemm_kernel_1.cu&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-21_gemm_kernel_1.cpp1.ii&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译出 PTX 和插桩文件</span></span><br><span class="line">$ cicc --c++17 --gnu_version=110400 --display_error_number --orig_src_file_name <span class="string">&quot;gemm_kernel_1.cu&quot;</span> --orig_src_path_name <span class="string">&quot;/home/zobin/projects/pos/test_cuda/gemm_kernel_1.cu&quot;</span> --allow_managed   -<span class="built_in">arch</span> compute_89 -m64 --no-version-ident -ftz=0 -prec_div=1 -prec_sqrt=1 -fmad=1 --include_file_name <span class="string">&quot;tmpxft_0000047f_00000000-7_gemm_kernel_1.fatbin.c&quot;</span> -tused --module_id_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-8_gemm_kernel_1.module_id&quot;</span> --gen_c_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-10_gemm_kernel_1.cudafe1.c&quot;</span> --stub_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-10_gemm_kernel_1.cudafe1.stub.c&quot;</span> --gen_device_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-10_gemm_kernel_1.cudafe1.gpu&quot;</span>  <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-21_gemm_kernel_1.cpp1.ii&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-10_gemm_kernel_1.ptx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译出 cubin (SASS)</span></span><br><span class="line">$ ptxas -<span class="built_in">arch</span>=sm_90 -m64  <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-10_gemm_kernel_1.ptx&quot;</span>  -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-22_gemm_kernel_1.sm_90.cubin&quot;</span> </span><br><span class="line">$ ptxas -<span class="built_in">arch</span>=sm_89 -m64  <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-10_gemm_kernel_1.ptx&quot;</span>  -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-23_gemm_kernel_1.sm_89.cubin&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 PTX 和 SASS 合并成为 fatbin.c</span></span><br><span class="line">$ fatbinary -64 --cicc-cmdline=<span class="string">&quot;-ftz=0 -prec_div=1 -prec_sqrt=1 -fmad=1 &quot;</span> <span class="string">&quot;--image3=kind=elf,sm=90,file=/tmp/tmpxft_0000047f_00000000-22_gemm_kernel_1.sm_90.cubin&quot;</span> <span class="string">&quot;--image3=kind=elf,sm=89,file=/tmp/tmpxft_0000047f_00000000-23_gemm_kernel_1.sm_89.cubin&quot;</span> <span class="string">&quot;--image3=kind=ptx,sm=89,file=/tmp/tmpxft_0000047f_00000000-10_gemm_kernel_1.ptx&quot;</span> --embedded-fatbin=<span class="string">&quot;/tmp/tmpxft_0000047f_00000000-7_gemm_kernel_1.fatbin.c&quot;</span> </span><br><span class="line">$ <span class="built_in">rm</span> /tmp/tmpxft_0000047f_00000000-7_gemm_kernel_1.fatbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译出 host 目标文件</span></span><br><span class="line">$ gcc -D__CUDA_ARCH__=890 -D__CUDA_ARCH_LIST__=890 -c -x c++  -DCUDA_DOUBLE_MATH_FUNCTIONS <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>   -m64 <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-10_gemm_kernel_1.cudafe1.cpp&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-24_gemm_kernel_1.o&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># ================== 处理 gemm_kernel_2.cu ==================</span></span><br><span class="line"><span class="comment"># 预处理 host 侧代码</span></span><br><span class="line">$ gcc -D__CUDA_ARCH_LIST__=890 -E -x c++ -D__CUDACC__ -D__NVCC__  <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>    -D__CUDACC_VER_MAJOR__=12 -D__CUDACC_VER_MINOR__=1 -D__CUDACC_VER_BUILD__=105 -D__CUDA_API_VER_MAJOR__=12 -D__CUDA_API_VER_MINOR__=1 -D__NVCC_DIAG_PRAGMA_SUPPORT__=1 -include <span class="string">&quot;cuda_runtime.h&quot;</span> -m64 <span class="string">&quot;gemm_kernel_2.cu&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-13_gemm_kernel_2.cpp4.ii&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 分离出 host 侧代码</span></span><br><span class="line">$ cudafe++ --c++17 --gnu_version=110400 --display_error_number --orig_src_file_name <span class="string">&quot;gemm_kernel_2.cu&quot;</span> --orig_src_path_name <span class="string">&quot;/home/zobin/projects/pos/test_cuda/gemm_kernel_2.cu&quot;</span> --allow_managed  --m64 --parse_templates --gen_c_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-14_gemm_kernel_2.cudafe1.cpp&quot;</span> --stub_file_name <span class="string">&quot;tmpxft_0000047f_00000000-14_gemm_kernel_2.cudafe1.stub.c&quot;</span> --gen_module_id_file --module_id_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-12_gemm_kernel_2.module_id&quot;</span> <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-13_gemm_kernel_2.cpp4.ii&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 预处理 device 侧代码</span></span><br><span class="line">$ gcc -D__CUDA_ARCH__=890 -D__CUDA_ARCH_LIST__=890 -E -x c++  -DCUDA_DOUBLE_MATH_FUNCTIONS -D__CUDACC__ -D__NVCC__  <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>    -D__CUDACC_VER_MAJOR__=12 -D__CUDACC_VER_MINOR__=1 -D__CUDACC_VER_BUILD__=105 -D__CUDA_API_VER_MAJOR__=12 -D__CUDA_API_VER_MINOR__=1 -D__NVCC_DIAG_PRAGMA_SUPPORT__=1 -include <span class="string">&quot;cuda_runtime.h&quot;</span> -m64 <span class="string">&quot;gemm_kernel_2.cu&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-25_gemm_kernel_2.cpp1.ii&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译出 PTX 和插桩文件</span></span><br><span class="line">$ cicc --c++17 --gnu_version=110400 --display_error_number --orig_src_file_name <span class="string">&quot;gemm_kernel_2.cu&quot;</span> --orig_src_path_name <span class="string">&quot;/home/zobin/projects/pos/test_cuda/gemm_kernel_2.cu&quot;</span> --allow_managed   -<span class="built_in">arch</span> compute_89 -m64 --no-version-ident -ftz=0 -prec_div=1 -prec_sqrt=1 -fmad=1 --include_file_name <span class="string">&quot;tmpxft_0000047f_00000000-11_gemm_kernel_2.fatbin.c&quot;</span> -tused --module_id_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-12_gemm_kernel_2.module_id&quot;</span> --gen_c_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-14_gemm_kernel_2.cudafe1.c&quot;</span> --stub_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-14_gemm_kernel_2.cudafe1.stub.c&quot;</span> --gen_device_file_name <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-14_gemm_kernel_2.cudafe1.gpu&quot;</span>  <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-25_gemm_kernel_2.cpp1.ii&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-14_gemm_kernel_2.ptx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译出 cubin (SASS)</span></span><br><span class="line">$ ptxas -<span class="built_in">arch</span>=sm_90 -m64  <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-14_gemm_kernel_2.ptx&quot;</span>  -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-26_gemm_kernel_2.sm_90.cubin&quot;</span> </span><br><span class="line">$ ptxas -<span class="built_in">arch</span>=sm_89 -m64  <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-14_gemm_kernel_2.ptx&quot;</span>  -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-27_gemm_kernel_2.sm_89.cubin&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 PTX 和 SASS 合并成为 fatbin.c</span></span><br><span class="line">$ fatbinary -64 --cicc-cmdline=<span class="string">&quot;-ftz=0 -prec_div=1 -prec_sqrt=1 -fmad=1 &quot;</span> <span class="string">&quot;--image3=kind=elf,sm=90,file=/tmp/tmpxft_0000047f_00000000-26_gemm_kernel_2.sm_90.cubin&quot;</span> <span class="string">&quot;--image3=kind=elf,sm=89,file=/tmp/tmpxft_0000047f_00000000-27_gemm_kernel_2.sm_89.cubin&quot;</span> <span class="string">&quot;--image3=kind=ptx,sm=89,file=/tmp/tmpxft_0000047f_00000000-14_gemm_kernel_2.ptx&quot;</span> --embedded-fatbin=<span class="string">&quot;/tmp/tmpxft_0000047f_00000000-11_gemm_kernel_2.fatbin.c&quot;</span> </span><br><span class="line">$ <span class="built_in">rm</span> /tmp/tmpxft_0000047f_00000000-11_gemm_kernel_2.fatbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译出 host 目标文件</span></span><br><span class="line">$ gcc -D__CUDA_ARCH__=890 -D__CUDA_ARCH_LIST__=890 -c -x c++  -DCUDA_DOUBLE_MATH_FUNCTIONS <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>   -m64 <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-14_gemm_kernel_2.cudafe1.cpp&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-28_gemm_kernel_2.o&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取出 sm_90 架构的 SASS 程序</span></span><br><span class="line">$ nvlink -m64 --<span class="built_in">arch</span>=sm_90 --register-link-binaries=<span class="string">&quot;/tmp/tmpxft_00000564_00000000-15_gemm_exe_dlink.reg.c&quot;</span>    <span class="string">&quot;-L/usr/local/cuda-12.1/bin/../targets/x86_64-linux/lib/stubs&quot;</span> <span class="string">&quot;-L/usr/local/cuda-12.1/bin/../targets/x86_64-linux/lib&quot;</span> -cpu-arch=X86_64 -report-arch <span class="string">&quot;/tmp/tmpxft_00000564_00000000-20_main.o&quot;</span> <span class="string">&quot;/tmp/tmpxft_00000564_00000000-24_gemm_kernel_1.o&quot;</span> <span class="string">&quot;/tmp/tmpxft_00000564_00000000-28_gemm_kernel_2.o&quot;</span>  -lcudadevrt  -o <span class="string">&quot;/tmp/tmpxft_00000564_00000000-29_gemm_exe_dlink.sm_90.cubin&quot;</span> --host-ccbin <span class="string">&quot;gcc&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取出 sm_89 架构的 SASS 程序</span></span><br><span class="line">$ nvlink -m64 --<span class="built_in">arch</span>=sm_89 --register-link-binaries=<span class="string">&quot;/tmp/tmpxft_00000564_00000000-15_gemm_exe_dlink.reg.c&quot;</span>    <span class="string">&quot;-L/usr/local/cuda-12.1/bin/../targets/x86_64-linux/lib/stubs&quot;</span> <span class="string">&quot;-L/usr/local/cuda-12.1/bin/../targets/x86_64-linux/lib&quot;</span> -cpu-arch=X86_64 -report-arch <span class="string">&quot;/tmp/tmpxft_00000564_00000000-20_main.o&quot;</span> <span class="string">&quot;/tmp/tmpxft_00000564_00000000-24_gemm_kernel_1.o&quot;</span> <span class="string">&quot;/tmp/tmpxft_00000564_00000000-28_gemm_kernel_2.o&quot;</span>  -lcudadevrt  -o <span class="string">&quot;/tmp/tmpxft_00000564_00000000-30_gemm_exe_dlink.sm_89.cubin&quot;</span> --host-ccbin <span class="string">&quot;gcc&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将两份 cubin (SASS 程序) 合并为 fatbin.c</span></span><br><span class="line">$ fatbinary -64 --cicc-cmdline=<span class="string">&quot;-ftz=0 -prec_div=1 -prec_sqrt=1 -fmad=1 &quot;</span> -<span class="built_in">link</span> <span class="string">&quot;--image3=kind=elf,sm=90,file=/tmp/tmpxft_00000564_00000000-29_gemm_exe_dlink.sm_90.cubin&quot;</span> <span class="string">&quot;--image3=kind=elf,sm=89,file=/tmp/tmpxft_00000564_00000000-30_gemm_exe_dlink.sm_89.cubin&quot;</span> --embedded-fatbin=<span class="string">&quot;/tmp/tmpxft_00000564_00000000-16_gemm_exe_dlink.fatbin.c&quot;</span> </span><br><span class="line">$ <span class="built_in">rm</span> /tmp/tmpxft_00000564_00000000-16_gemm_exe_dlink.fatbin</span><br><span class="line"></span><br><span class="line">$ gcc -D__CUDA_ARCH_LIST__=890 -c -x c++ -DFATBINFILE=<span class="string">&quot;\&quot;/tmp/tmpxft_00000564_00000000-16_gemm_exe_dlink.fatbin.c\&quot;&quot;</span> -DREGISTERLINKBINARYFILE=<span class="string">&quot;\&quot;/tmp/tmpxft_00000564_00000000-15_gemm_exe_dlink.reg.c\&quot;&quot;</span> -I. -D__NV_EXTRA_INITIALIZATION= -D__NV_EXTRA_FINALIZATION= -D__CUDA_INCLUDE_COMPILER_INTERNAL_HEADERS__  <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>    -D__CUDACC_VER_MAJOR__=12 -D__CUDACC_VER_MINOR__=1 -D__CUDACC_VER_BUILD__=105 -D__CUDA_API_VER_MAJOR__=12 -D__CUDA_API_VER_MINOR__=1 -D__NVCC_DIAG_PRAGMA_SUPPORT__=1 -m64 <span class="string">&quot;/usr/local/cuda-12.1/bin/crt/link.stub&quot;</span> -o <span class="string">&quot;/tmp/tmpxft_00000564_00000000-31_gemm_exe_dlink.o&quot;</span> </span><br><span class="line"></span><br><span class="line">$ g++ -D__CUDA_ARCH_LIST__=890 -m64 -Wl,--start-group <span class="string">&quot;/tmp/tmpxft_00000564_00000000-31_gemm_exe_dlink.o&quot;</span> <span class="string">&quot;/tmp/tmpxft_00000564_00000000-20_main.o&quot;</span> <span class="string">&quot;/tmp/tmpxft_00000564_00000000-24_gemm_kernel_1.o&quot;</span> <span class="string">&quot;/tmp/tmpxft_00000564_00000000-28_gemm_kernel_2.o&quot;</span>   <span class="string">&quot;-L/usr/local/cuda-12.1/bin/../targets/x86_64-linux/lib/stubs&quot;</span> <span class="string">&quot;-L/usr/local/cuda-12.1/bin/../targets/x86_64-linux/lib&quot;</span>  -lcudadevrt  -lcudart_static  -lrt -lpthread  -ldl  -Wl,--end-group -o <span class="string">&quot;gemm_exe&quot;</span> </span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;下面我们按照上面的日志输出内容，逐命令地对编译过程进行分析。

  <div class="noteblock">
  在下面执行的命令中，我们把原始命令中的 <code>tmp</code> 改为了本地临时文件夹 <code>./tmp</code>，方便我们进行文件增删的分析。
  </div>
</div>

<h2 class="title"><code>main.cu</code> 的编译</h2>
<div class="div_learning_post">
<label class="title">main_cu_comile</label>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;首先我们对 <code>main.cu</code> 代码的编译过程进行拆解。

  <h3 class="title">预处理 Host 侧源代码</h3>

  <div class="code_segment" label="preprocess_host">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">gcc -D__CUDA_ARCH_LIST__=890                                      \</span><br><span class="line">    -E                                                            \</span><br><span class="line">    -x c++                                                        \</span><br><span class="line">    -D__CUDACC__                                                  \</span><br><span class="line">    -D__NVCC__                                                    \</span><br><span class="line">    <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>  \</span><br><span class="line">    -D__CUDACC_VER_MAJOR__=12                                     \</span><br><span class="line">    -D__CUDACC_VER_MINOR__=1                                      \</span><br><span class="line">    -D__CUDACC_VER_BUILD__=105                                    \</span><br><span class="line">    -D__CUDA_API_VER_MAJOR__=12                                   \</span><br><span class="line">    -D__CUDA_API_VER_MINOR__=1                                    \</span><br><span class="line">    -D__NVCC_DIAG_PRAGMA_SUPPORT__=1                              \</span><br><span class="line">    -include <span class="string">&quot;cuda_runtime.h&quot;</span>                                     \</span><br><span class="line">    -m64 <span class="string">&quot;main.cu&quot;</span>                                                \</span><br><span class="line">    -o <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-5_main.cpp4.ii&quot;</span> </span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;运行了上述命令后，文件夹结构如下所示:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  .</span><br><span class="line"><span class="comment"># ├── gemm_kernel.cuh</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_1.cu</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_2.cu</span></span><br><span class="line"><span class="comment"># ├── main.cu</span></span><br><span class="line">  └── tmp</span><br><span class="line">       └── tmpxft_0000047f_00000000-5_main.cpp4.ii</span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;上述命令实际上是 <code>gcc -E</code> 指令，目的是对 <code>main.cu</code> 进行 <def>预处理 (pre-process) / 预编译 (pre-compile)</def> 操作，也即把存在于头文件中的宏、结构体定义等，在 <code>main.cu</code> 中进行定义和展开。同时上述命令还在生成的文件中添加了若干宏定义，生成的文件 <code>main.cpp4.ii</code> 是一个长达 3 万行的代码文件，截取其中内容，如下所示:

  <div class="code_segment" file="main.cpp4.ii">

  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">__attribute__</span>((device_builtin)) char1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">signed</span> <span class="type">char</span> x;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">__attribute__</span>((device_builtin)) uchar1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> x;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">__attribute__</span>((device_builtin)) __attribute__((<span class="built_in">aligned</span>(<span class="number">2</span>))) char2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">signed</span> <span class="type">char</span> x, y;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"># <span class="number">1</span> <span class="string">&quot;gemm_kernel.cuh&quot;</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"># <span class="number">4</span> <span class="string">&quot;gemm_kernel.cuh&quot;</span></span><br><span class="line">__attribute__((global)) <span class="function"><span class="type">void</span> <span class="title">gemm_kernel_1</span><span class="params">(<span class="type">const</span> <span class="type">int</span> *a, <span class="type">const</span> <span class="type">int</span> *<span class="type">b_t</span>, <span class="type">int</span> *c, <span class="type">const</span> <span class="type">int</span> m, <span class="type">const</span> <span class="type">int</span> n, <span class="type">const</span> <span class="type">int</span> k)</span></span>;</span><br><span class="line">__attribute__((global)) <span class="function"><span class="type">void</span> <span class="title">gemm_kernel_2</span><span class="params">(<span class="type">const</span> <span class="type">int</span> *a, <span class="type">const</span> <span class="type">int</span> *b, <span class="type">int</span> *c, <span class="type">const</span> <span class="type">int</span> m, <span class="type">const</span> <span class="type">int</span> n, <span class="type">const</span> <span class="type">int</span> k)</span></span>;</span><br><span class="line"># <span class="number">6</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> m=<span class="number">64</span>, n=<span class="number">128</span>, k=<span class="number">32</span>;</span><br><span class="line">  <span class="type">int</span> *da = </span><br><span class="line"># <span class="number">9</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">          __null</span><br><span class="line"># <span class="number">9</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">              , *db = </span><br><span class="line"># <span class="number">9</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">                      __null</span><br><span class="line"># <span class="number">9</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">                          , *dc = </span><br><span class="line"># <span class="number">9</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">                                  __null</span><br><span class="line"># <span class="number">9</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">                                      ;</span><br><span class="line">  <span class="type">int</span> *ha = </span><br><span class="line"># <span class="number">10</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">          __null</span><br><span class="line"># <span class="number">10</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">              , *hb = </span><br><span class="line"># <span class="number">10</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">                      __null</span><br><span class="line"># <span class="number">10</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">                          , *hc = </span><br><span class="line"># <span class="number">10</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">                                  __null</span><br><span class="line"># <span class="number">10</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">                                      ;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaMalloc</span>((<span class="type">void</span> **)&amp;da, m*n*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (da == </span><br><span class="line"># <span class="number">13</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">          __null</span><br><span class="line"># <span class="number">13</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">              ) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;GPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaMalloc</span>((<span class="type">void</span> **)&amp;db, n*k*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (db == </span><br><span class="line"># <span class="number">19</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">          __null</span><br><span class="line"># <span class="number">19</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">              ) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;GPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaMalloc</span>((<span class="type">void</span> **)&amp;dc, m*k*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (dc == </span><br><span class="line"># <span class="number">25</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">          __null</span><br><span class="line"># <span class="number">25</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">              ) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;GPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ha = (<span class="type">int</span> *)<span class="built_in">malloc</span>(m*n*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (ha == </span><br><span class="line"># <span class="number">31</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">          __null</span><br><span class="line"># <span class="number">31</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">              ) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;m*n; i++)&#123;</span><br><span class="line">    ha[i] = <span class="built_in">rand</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hb = (<span class="type">int</span> *)<span class="built_in">malloc</span>(n*k*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (hb == </span><br><span class="line"># <span class="number">40</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">          __null</span><br><span class="line"># <span class="number">40</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">              ) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;n*k; i++)&#123;</span><br><span class="line">    hb[i] = <span class="built_in">rand</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hc = (<span class="type">int</span> *)<span class="built_in">malloc</span>(m*k*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (hc == </span><br><span class="line"># <span class="number">49</span> <span class="string">&quot;main.cu&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">          __null</span><br><span class="line"># <span class="number">49</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">              ) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CPU alloc fail&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaMemcpy</span>(da, ha, m*n*<span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyHostToDevice);</span><br><span class="line">  <span class="built_in">cudaMemcpy</span>(db, hb, n*k*<span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyHostToDevice);</span><br><span class="line"></span><br><span class="line">  gemm_kernel_1&lt;&lt;&lt;<span class="number">1</span>,<span class="number">256</span>&gt;&gt;&gt;(da, db, dc, m, n, k);</span><br><span class="line">  <span class="built_in">cudaMemcpy</span>(hc, dc, m*k*<span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyDeviceToHost);</span><br><span class="line"></span><br><span class="line">  gemm_kernel_2&lt;&lt;&lt;<span class="number">1</span>,<span class="number">256</span>&gt;&gt;&gt;(da, db, dc, m, n, k);</span><br><span class="line">  <span class="built_in">cudaMemcpy</span>(hc, dc, m*k*<span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyDeviceToHost);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaFree</span>(da); <span class="built_in">cudaFree</span>(db); <span class="built_in">cudaFree</span>(dc);</span><br><span class="line">  <span class="built_in">free</span>(ha); <span class="built_in">free</span>(hb); <span class="built_in">free</span>(hc);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;在上述代码中，我们在 Line 24 和 25 处可以看见 <code>gemm_kernel.cuh</code> 的函数声明被展开到了 <code>main.cpp4.ii</code> 中，并且 <code>__global__</code> 的前缀被更换为了 <code>__attribute__((global))</code>；另外我们在 Line 126 和 Line 129 处仍然可以看见程序使用 <code><<<>>></code> 的方式来异步地调用 kernel，可见此时程序只是进行了预处理工作，CUDA device 侧程序和 CUDA Runtime 的程序用法，依然和 Host 侧代码没有分离。

  <h3 class="title">分离 Host 侧源代码</h3>

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cudafe++  --c++17                                                                                       \</span><br><span class="line">          --gnu_version=110400                                                                          \</span><br><span class="line">          --display_error_number                                                                        \</span><br><span class="line">          --orig_src_file_name <span class="string">&quot;main.cu&quot;</span>                                                                \</span><br><span class="line">          --orig_src_path_name <span class="string">&quot;/home/zobin/projects/pos/test_cuda/main.cu&quot;</span>                             \</span><br><span class="line">          --allow_managed                                                                               \</span><br><span class="line">          --m64                                                                                         \</span><br><span class="line">          --parse_templates                                                                             \</span><br><span class="line">          --gen_c_file_name <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-6_main.cudafe1.cpp&quot;</span>                         \</span><br><span class="line">          --stub_file_name <span class="string">&quot;tmpxft_0000047f_00000000-6_main.cudafe1.stub.c&quot;</span>                             \</span><br><span class="line">          --gen_module_id_file --module_id_file_name <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-4_main.module_id&quot;</span>  \</span><br><span class="line">          <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-5_main.cpp4.ii&quot;</span></span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;命令运行后，文件夹结构如下所示:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  .</span><br><span class="line"><span class="comment"># ├── gemm_kernel.cuh</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_1.cu</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_2.cu</span></span><br><span class="line"><span class="comment"># ├── main.cu</span></span><br><span class="line">  └── tmp</span><br><span class="line">       ├── tmpxft_0000047f_00000000-4_main.module_id</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-5_main.cpp4.ii</span></span><br><span class="line">       └── tmpxft_0000047f_00000000-6_main.cudafe1.cpp</span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;可见运行后，将会生成两个新文件: <code>main.cudafe1.cpp</code> 和 <code>main.module_id</code> 文件。其中 <code>main.cudafe1.cpp</code> 的文件内容摘抄如下:

  <div class="code_segment" file="main.cudafe1.cpp" label="cudafe1_cpp">

  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">4</span> <span class="string">&quot;gemm_kernel.cuh&quot;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gemm_kernel_1</span><span class="params">(<span class="type">const</span> <span class="type">int</span> * a, <span class="type">const</span> <span class="type">int</span> * <span class="type">b_t</span>, <span class="type">int</span> * c, <span class="type">const</span> <span class="type">int</span> m, <span class="type">const</span> <span class="type">int</span> n, <span class="type">const</span> <span class="type">int</span> k)</span></span>; </span><br><span class="line"># <span class="number">5</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gemm_kernel_2</span><span class="params">(<span class="type">const</span> <span class="type">int</span> * a, <span class="type">const</span> <span class="type">int</span> * b, <span class="type">int</span> * c, <span class="type">const</span> <span class="type">int</span> m, <span class="type">const</span> <span class="type">int</span> n, <span class="type">const</span> <span class="type">int</span> k)</span></span>; </span><br><span class="line"># <span class="number">7</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; </span><br><span class="line"># <span class="number">8</span></span><br><span class="line"><span class="type">int</span> m = <span class="number">64</span>, n = <span class="number">128</span>, k = <span class="number">32</span>; </span><br><span class="line"># <span class="number">9</span></span><br><span class="line"><span class="type">int</span> *da = (__null), </span><br><span class="line"># <span class="number">9</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">*db = (__null), </span><br><span class="line"># <span class="number">9</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">*dc = (__null); </span><br><span class="line"># <span class="number">10</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line"><span class="type">int</span> *ha = (__null), </span><br><span class="line"># <span class="number">10</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">*hb = (__null), </span><br><span class="line"># <span class="number">10</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">*hc = (__null); </span><br><span class="line"># <span class="number">12</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line"><span class="built_in">cudaMalloc</span>((<span class="type">void</span> **)(&amp;da), (m * n) * <span class="built_in">sizeof</span>(<span class="type">int</span>)); </span><br><span class="line"># <span class="number">13</span></span><br><span class="line"><span class="keyword">if</span> (da == (__null)) </span><br><span class="line"># <span class="number">13</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">&#123; </span><br><span class="line"># <span class="number">14</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;GPU alloc fail&quot;</span>); </span><br><span class="line"># <span class="number">15</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>; </span><br><span class="line"># <span class="number">16</span></span><br><span class="line">&#125;  </span><br><span class="line"># <span class="number">18</span></span><br><span class="line"><span class="built_in">cudaMalloc</span>((<span class="type">void</span> **)(&amp;db), (n * k) * <span class="built_in">sizeof</span>(<span class="type">int</span>)); </span><br><span class="line"># <span class="number">19</span></span><br><span class="line"><span class="keyword">if</span> (db == (__null)) </span><br><span class="line"># <span class="number">19</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">&#123; </span><br><span class="line"># <span class="number">20</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;GPU alloc fail&quot;</span>); </span><br><span class="line"># <span class="number">21</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>; </span><br><span class="line"># <span class="number">22</span></span><br><span class="line">&#125;  </span><br><span class="line"># <span class="number">24</span></span><br><span class="line"><span class="built_in">cudaMalloc</span>((<span class="type">void</span> **)(&amp;dc), (m * k) * <span class="built_in">sizeof</span>(<span class="type">int</span>)); </span><br><span class="line"># <span class="number">25</span></span><br><span class="line"><span class="keyword">if</span> (dc == (__null)) </span><br><span class="line"># <span class="number">25</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">&#123; </span><br><span class="line"># <span class="number">26</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;GPU alloc fail&quot;</span>); </span><br><span class="line"># <span class="number">27</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>; </span><br><span class="line"># <span class="number">28</span></span><br><span class="line">&#125;  </span><br><span class="line"># <span class="number">30</span></span><br><span class="line">ha = ((<span class="type">int</span> *)<span class="built_in">malloc</span>((m * n) * <span class="built_in">sizeof</span>(<span class="type">int</span>))); </span><br><span class="line"># <span class="number">31</span></span><br><span class="line"><span class="keyword">if</span> (ha == (__null)) </span><br><span class="line"># <span class="number">31</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">&#123; </span><br><span class="line"># <span class="number">32</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CPU alloc fail&quot;</span>); </span><br><span class="line"># <span class="number">33</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>; </span><br><span class="line"># <span class="number">34</span></span><br><span class="line">&#125;  </span><br><span class="line"># <span class="number">35</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (m * n); i++) &#123; </span><br><span class="line"># <span class="number">36</span></span><br><span class="line">(ha[i]) = <span class="built_in">rand</span>(); </span><br><span class="line"># <span class="number">37</span></span><br><span class="line">&#125;  </span><br><span class="line"># <span class="number">39</span></span><br><span class="line">hb = ((<span class="type">int</span> *)<span class="built_in">malloc</span>((n * k) * <span class="built_in">sizeof</span>(<span class="type">int</span>))); </span><br><span class="line"># <span class="number">40</span></span><br><span class="line"><span class="keyword">if</span> (hb == (__null)) </span><br><span class="line"># <span class="number">40</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">&#123; </span><br><span class="line"># <span class="number">41</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CPU alloc fail&quot;</span>); </span><br><span class="line"># <span class="number">42</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>; </span><br><span class="line"># <span class="number">43</span></span><br><span class="line">&#125;  </span><br><span class="line"># <span class="number">44</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (n * k); i++) &#123; </span><br><span class="line"># <span class="number">45</span></span><br><span class="line">(hb[i]) = <span class="built_in">rand</span>(); </span><br><span class="line"># <span class="number">46</span></span><br><span class="line">&#125;  </span><br><span class="line"># <span class="number">48</span></span><br><span class="line">hc = ((<span class="type">int</span> *)<span class="built_in">malloc</span>((m * k) * <span class="built_in">sizeof</span>(<span class="type">int</span>))); </span><br><span class="line"># <span class="number">49</span></span><br><span class="line"><span class="keyword">if</span> (hc == (__null)) </span><br><span class="line"># <span class="number">49</span> <span class="string">&quot;main.cu&quot;</span></span><br><span class="line">&#123; </span><br><span class="line"># <span class="number">50</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CPU alloc fail&quot;</span>); </span><br><span class="line"># <span class="number">51</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>; </span><br><span class="line"># <span class="number">52</span></span><br><span class="line">&#125;  </span><br><span class="line"># <span class="number">54</span></span><br><span class="line"><span class="built_in">cudaMemcpy</span>(da, ha, (m * n) * <span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyHostToDevice); </span><br><span class="line"># <span class="number">55</span></span><br><span class="line"><span class="built_in">cudaMemcpy</span>(db, hb, (n * k) * <span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyHostToDevice); </span><br><span class="line"># <span class="number">57</span></span><br><span class="line">(__cudaPushCallConfiguration(<span class="number">1</span>, <span class="number">256</span>)) ? (<span class="type">void</span>)<span class="number">0</span> : <span class="built_in">gemm_kernel_1</span>(da, db, dc, m, n, k); </span><br><span class="line"># <span class="number">58</span></span><br><span class="line"><span class="built_in">cudaMemcpy</span>(hc, dc, (m * k) * <span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyDeviceToHost); </span><br><span class="line"># <span class="number">60</span></span><br><span class="line">(__cudaPushCallConfiguration(<span class="number">1</span>, <span class="number">256</span>)) ? (<span class="type">void</span>)<span class="number">0</span> : <span class="built_in">gemm_kernel_2</span>(da, db, dc, m, n, k); </span><br><span class="line"># <span class="number">61</span></span><br><span class="line"><span class="built_in">cudaMemcpy</span>(hc, dc, (m * k) * <span class="built_in">sizeof</span>(<span class="type">int</span>), cudaMemcpyDeviceToHost); </span><br><span class="line"># <span class="number">63</span></span><br><span class="line"><span class="built_in">cudaFree</span>(da); <span class="built_in">cudaFree</span>(db); <span class="built_in">cudaFree</span>(dc); </span><br><span class="line"># <span class="number">64</span></span><br><span class="line"><span class="built_in">free</span>(ha); <span class="built_in">free</span>(hb); <span class="built_in">free</span>(hc); </span><br><span class="line"># <span class="number">65</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line"># <span class="number">66</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"># <span class="number">1</span> <span class="string">&quot;tmpxft_0000047f_00000000-6_main.cudafe1.stub.c&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _NV_ANON_NAMESPACE _GLOBAL__N__9df44bf1_7_main_cu_main</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _NV_ANON_NAMESPACE</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"># <span class="number">1</span> <span class="string">&quot;tmpxft_0000047f_00000000-6_main.cudafe1.stub.c&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tmpxft_0000047f_00000000-6_main.cudafe1.stub.c&quot;</span></span></span><br><span class="line"># <span class="number">1</span> <span class="string">&quot;tmpxft_0000047f_00000000-6_main.cudafe1.stub.c&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> _NV_ANON_NAMESPACE</span></span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;在 Line 2 和 Line 4 中可以看见，kernel 的定函数声明中 <code>__attribute__((global))</code> 的编译器注释已经被去掉了，实际上这里留下的是同名的函数接口声明 <code>void gemm_kernel_x(const int*, const int*, int*, const int, const int, const int)</code> (以下简称为 <code>gemm_kernel_x</code> 接口)；另外，在 Line 110 和 Line 114 中可以看见，kernel launch 的方式已经被改为了先调用 <code>__cudaPushCallConfiguration</code> 将 Launch 参数 (e.g., gridDim, blockDim, etc.) push 到某处，然后直接运行 <code>gemm_kernel_x</code> 接口。综上，此时的 Host 侧代码已经和 Device 侧代码分离开来了，<code>main.cudafe1.cpp</code> 中包括的是 Host 侧的代码。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;值得注意的是，在 Line 126~133 还可以看见 <code>main.cudafe1.cpp</code> include 了 <code>main.cudafe1.stub.c</code> 文件，后者在此时还没有被生成，实际上后者将间接包含编译后的 Device 侧代码，我们在下文将会看到它的内容。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;另外，<code>main.module_id</code> 文件内容如下所示，该文件存储了当前正在编译的 CUDA module 的 id 信息，我们在后文把它称为 module_id。

  <div class="code_segment" file="main.module_id">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_9df44bf1_7_main_cu_main</span><br></pre></td></tr></table></figure>
  </div>

  <h3 class="title">预处理 Device 侧源代码</h3>
  <div class="code_segment" label="preprocess_device">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gcc -D__CUDA_ARCH__=890                                           \</span><br><span class="line">    -D__CUDA_ARCH_LIST__=890                                      \</span><br><span class="line">    -E                                                            \</span><br><span class="line">    -x c++                                                        \</span><br><span class="line">    -DCUDA_DOUBLE_MATH_FUNCTIONS                                  \</span><br><span class="line">    -D__CUDACC__                                                  \</span><br><span class="line">    -D__NVCC__                                                    \</span><br><span class="line">    <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>  \</span><br><span class="line">    -D__CUDACC_VER_MAJOR__=12                                     \</span><br><span class="line">    -D__CUDACC_VER_MINOR__=1                                      \</span><br><span class="line">    -D__CUDACC_VER_BUILD__=105                                    \</span><br><span class="line">    -D__CUDA_API_VER_MAJOR__=12                                   \</span><br><span class="line">    -D__CUDA_API_VER_MINOR__=1                                    \</span><br><span class="line">    -D__NVCC_DIAG_PRAGMA_SUPPORT__=1                              \</span><br><span class="line">    -include <span class="string">&quot;cuda_runtime.h&quot;</span>                                     \</span><br><span class="line">    -m64 <span class="string">&quot;main.cu&quot;</span>                                                \</span><br><span class="line">    -o <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-17_main.cpp1.ii&quot;</span></span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;命令运行后，文件夹结构如下所示:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  .</span><br><span class="line"><span class="comment"># ├── gemm_kernel.cuh</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_1.cu</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_2.cu</span></span><br><span class="line"><span class="comment"># ├── main.cu</span></span><br><span class="line">  └── tmp</span><br><span class="line">       ├── tmpxft_0000047f_00000000-17_main.cpp1.ii</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-4_main.module_id</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-5_main.cpp4.ii</span></span><br><span class="line"><span class="comment">#      └── tmpxft_0000047f_00000000-6_main.cudafe1.cpp</span></span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;实际上 <coderef>preprocess_device</coderef> 和 <coderef>preprocess_host</coderef> 处展示的命令是一样的，就是对 <code>main.cu</code> 进行预处理。这里的预处理唯一的不同可能就是多加了宏定义 <code>__CUDA_ARCH__</code>，该命令生成的文件是 <code>main.cpp1.ii</code>，由于内容和 <code>main.cpp4.ii</code> 并无明显出入，此处不再赘述。

  <h3 class="title">编译出 PTX 代码</h3>

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cicc  --c++17                                                                     \</span><br><span class="line">      --gnu_version=110400                                                        \</span><br><span class="line">      --display_error_number                                                      \</span><br><span class="line">      --orig_src_file_name <span class="string">&quot;main.cu&quot;</span>                                              \</span><br><span class="line">      --orig_src_path_name <span class="string">&quot;/home/zobin/projects/pos/test_cuda/main.cu&quot;</span>           \</span><br><span class="line">      --allow_managed                                                             \</span><br><span class="line">      -<span class="built_in">arch</span> compute_89                                                            \</span><br><span class="line">      -m64                                                                        \</span><br><span class="line">      --no-version-ident                                                          \</span><br><span class="line">      -ftz=0                                                                      \</span><br><span class="line">      -prec_div=1                                                                 \</span><br><span class="line">      -prec_sqrt=1                                                                \</span><br><span class="line">      -fmad=1                                                                     \</span><br><span class="line">      --include_file_name <span class="string">&quot;tmpxft_0000047f_00000000-3_main.fatbin.c&quot;</span>              \</span><br><span class="line">      -tused                                                                      \</span><br><span class="line">      --module_id_file_name <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-4_main.module_id&quot;</span>     \</span><br><span class="line">      --gen_c_file_name <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-6_main.cudafe1.c&quot;</span>         \</span><br><span class="line">      --stub_file_name <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-6_main.cudafe1.stub.c&quot;</span>     \</span><br><span class="line">      --gen_device_file_name <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-6_main.cudafe1.gpu&quot;</span>  \</span><br><span class="line">      <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-17_main.cpp1.ii&quot;</span>                            \</span><br><span class="line">      -o <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-6_main.ptx&quot;</span></span><br></pre></td></tr></table></figure>
  <div class="noteblock">
  <code>cicc</code> 大概率不在系统 binary 搜索路径下，需要手动向 terminal 配置文件中添加:<br>
  <code>export PATH=/usr/local/cuda-12.1/nvvm/bin:$PATH</code>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;运行了上述命令后，文件夹结构如下所示:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  .</span><br><span class="line"><span class="comment"># ├── gemm_kernel.cuh</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_1.cu</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_2.cu</span></span><br><span class="line"><span class="comment"># ├── main.cu</span></span><br><span class="line">  └── tmp</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-17_main.cpp1.ii</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-4_main.module_id</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-5_main.cpp4.ii</span></span><br><span class="line">       ├── tmpxft_0000047f_00000000-6_main.cudafe1.c</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.cpp</span></span><br><span class="line">       ├── tmpxft_0000047f_00000000-6_main.cudafe1.gpu</span><br><span class="line">       ├── tmpxft_0000047f_00000000-6_main.cudafe1.stub.c</span><br><span class="line">       └── tmpxft_0000047f_00000000-6_main.ptx</span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;可见一共生成了 4 个新文件，其中较为重要的 2 个文件是 <code>main.ptx</code> 和 <code>cudafe1.stub.c</code>。

  <div class="code_segment" file="cudafe1.stub.c" label="stub">

  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wunused-function&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wcast-qual&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NV_CUBIN_HANDLE_STORAGE__ static</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(__CUDA_INCLUDE_COMPILER_INTERNAL_HEADERS__)</span></span><br><span class="line">  <span class="meta">#<span class="keyword">define</span> __CUDA_INCLUDE_COMPILER_INTERNAL_HEADERS__</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;crt/host_runtime.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tmpxft_0000047f_00000000-3_main.fatbin.c&quot;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __nv_cudaEntityRegisterCallback(<span class="type">void</span> **);</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __sti____cudaRegisterAll(<span class="type">void</span>) __attribute__((__constructor__));</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __nv_cudaEntityRegisterCallback(<span class="type">void</span> **__T2)&#123;</span><br><span class="line">  __nv_dummy_param_ref(__T2);</span><br><span class="line">  __nv_save_fatbinhandle_for_managed_rt(__T2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __sti____cudaRegisterAll(<span class="type">void</span>)&#123;</span><br><span class="line">  __cudaRegisterBinary(__nv_cudaEntityRegisterCallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;<code>cudafe1.stub.c</code> 文件的内容如 <coderef>stub</coderef> 所示，在 Line 11 中我们可以观察到一个被标记为 <code>__attribute__((__constructor__))</code> 的函数 <code>__sti____cudaRegisterAll</code>，这意味着它会在程序启动时被执行，它的定义位于 Line 16-18，可以看见它调用了 <code>__cudaRegisterBinary</code>，顾名思义是在注册跑在 device 上的二进制程序。<code>__cudaRegisterBinary</code> 是一个 CUDA Runtime 的内部 API，我们可以看到它的逻辑是传入注册回调函数 <code>__nv_cudaEntityRegisterCallback</code>，由于在 <code>main.cu</code> 中我们并没有定义任何 kernels，因此我们在这个用于注册的回调函数中并不能看到过多细节，在 <ref>compile_gemm_kernel_1</ref> 中我们将看到 1 个 kernel 被注册进 runtime 的更多细节。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;而对于 <code>main.ptx</code>，由于我们在 <code>main.cu</code> 中没有定义任何 kernel，所以在 <coderef>main_ptx</coderef> 中并没有任何内容。

  <div class="code_segment" file="main.ptx" label="main_ptx">

  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">// Generated by NVIDIA NVVM Compiler</span><br><span class="line">//</span><br><span class="line">// Compiler Build ID: CL-32688072</span><br><span class="line">// Cuda compilation tools, release 12.1, V12.1.105</span><br><span class="line">// Based on NVVM 7.0.1</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">.version 8.1</span><br><span class="line">.target sm_89</span><br><span class="line">.address_size 64</span><br></pre></td></tr></table></figure>
  </div>

  <h3 class="title">编译出 SASS 代码 (cubin)</h3>

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ptxas -<span class="built_in">arch</span>=sm_90 -m64  <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-6_main.ptx&quot;</span>  -o <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-18_main.sm_90.cubin&quot;</span> </span><br><span class="line">ptxas -<span class="built_in">arch</span>=sm_89 -m64  <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-6_main.ptx&quot;</span>  -o <span class="string">&quot;./tmp/tmpxft_0000047f_00000000-19_main.sm_89.cubin&quot;</span> </span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;运行了上述命令后，文件夹结构如下所示:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  .</span><br><span class="line"><span class="comment"># ├── gemm_kernel.cuh</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_1.cu</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_2.cu</span></span><br><span class="line"><span class="comment"># ├── main.cu</span></span><br><span class="line">  └── tmp</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-17_main.cpp1.ii</span></span><br><span class="line">       ├── tmpxft_0000047f_00000000-18_main.sm_90.cubin</span><br><span class="line">       ├── tmpxft_0000047f_00000000-19_main.sm_89.cubin</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-4_main.module_id</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-5_main.cpp4.ii</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.c</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.cpp</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.gpu</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.stub.c</span></span><br><span class="line"><span class="comment">#      └── tmpxft_0000047f_00000000-6_main.ptx</span></span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;新生成的 <code>main.sm_90.cubin</code> 和 <code>main.sm_89.cubin</code> 理论上应包含在设备上被执行的 SASS 二进制。同理，由于我们在 <code>main.cu</code> 并没有定义任何 kernels，因此这两个 cubin 文件中不会包含任何内容，如 <coderef>empty_cubin_1</coderef> 和 <coderef>empty_cubin_2</coderef> 所示。

  <div class="code_segment" label="empty_cubin_1">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -s ./tmp/tmpxft_0000047f_00000000-18_main.sm_90.cubin</span><br><span class="line">./tmp/tmpxft_0000047f_00000000-18_main.sm_90.cubin:     file format elf64-little</span><br></pre></td></tr></table></figure>
  </div>

  <div class="code_segment" label="empty_cubin_2">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -s ./tmp/tmpxft_0000047f_00000000-19_main.sm_89.cubin</span><br><span class="line">./tmp/tmpxft_0000047f_00000000-19_main.sm_89.cubin:     file format elf64-little</span><br></pre></td></tr></table></figure>
  </div>

  <h3 class="title">合并 PTX 和 SASS 代码 (合并 ptx 和 cubin 生成 fatbin)</h3>

  <div class="code_segment">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fatbinary -64                                                                               \</span><br><span class="line">          --cicc-cmdline=                                                                   \</span><br><span class="line">          <span class="string">&quot;-ftz=0 -prec_div=1 -prec_sqrt=1 -fmad=1 &quot;</span>                                        \</span><br><span class="line">          <span class="string">&quot;--image3=kind=elf,sm=90,file=./tmp/tmpxft_0000047f_00000000-18_main.sm_90.cubin&quot;</span> \</span><br><span class="line">          <span class="string">&quot;--image3=kind=elf,sm=89,file=./tmp/tmpxft_0000047f_00000000-19_main.sm_89.cubin&quot;</span> \</span><br><span class="line">          <span class="string">&quot;--image3=kind=ptx,sm=89,file=./tmp/tmpxft_0000047f_00000000-6_main.ptx&quot;</span>          \</span><br><span class="line">          --embedded-fatbin=<span class="string">&quot;./tmp/tmpxft_0000047f_00000000-3_main.fatbin.c&quot;</span></span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;运行了上述命令后，文件夹结构如下所示:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  .</span><br><span class="line"><span class="comment"># ├── gemm_kernel.cuh</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_1.cu</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_2.cu</span></span><br><span class="line"><span class="comment"># ├── main.cu</span></span><br><span class="line">  └── tmp</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-17_main.cpp1.ii</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-18_main.sm_90.cubin</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-19_main.sm_89.cubin</span></span><br><span class="line">       ├── tmpxft_0000047f_00000000-3_main.fatbin.c</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-4_main.module_id</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-5_main.cpp4.ii</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.c</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.cpp</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.gpu</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.stub.c</span></span><br><span class="line"><span class="comment">#      └── tmpxft_0000047f_00000000-6_main.ptx</span></span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;上述命令将 <code>main.sm_89.cubin</code>，<code>main.sm_90.cubin</code> 和 <code>main.ptx</code> 合并到了 <code>main.fatbin.c</code> 中，后者的文件内容如下所示:

  <div class="code_segment" file="main.fatbin.c" label="main_fatbin_c">

  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __SKIP_INTERNAL_FATBINARY_HEADERS</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fatbinary_section.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __CUDAFATBINSECTION  <span class="string">&quot;.nvFatBinSegment&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __CUDAFATBINDATASECTION  <span class="string">&quot;.nv_fatbin&quot;</span></span></span><br><span class="line"><span class="keyword">asm</span>(</span><br><span class="line"><span class="string">&quot;.section .nv_fatbin, \&quot;a\&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;.align 8\n&quot;</span></span><br><span class="line"><span class="string">&quot;fatbinData:\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x00100001ba55ed50,0x0000000000000658,0x0000004001010002,0x00000000000002b0\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000005a00010007,0x0000000000000000,0x0000000000000011\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x33010102464c457f,0x0000000000000007\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000007900be0002,0x0000000000000000,0x0000000000000240,0x0000000000000100\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x003800400059055a,0x0001000500400002,0x7472747368732e00,0x747274732e006261\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x746d79732e006261,0x746d79732e006261,0x78646e68735f6261,0x7466752e766e2e00\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x2e007972746e652e,0x006f666e692e766e,0x665f67756265642e,0x00000000656d6172\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x7368732e00000000,0x732e006261747274,0x732e006261747274\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x732e006261746d79,0x68735f6261746d79,0x2e766e2e0078646e,0x72746e652e746675\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x6e692e766e2e0079,0x756265642e006f66,0x00656d6172665f67,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x0000000000000000,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x0000000000000000,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x0000000300000001,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000040,0x000000000000004d,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000001,0x0000000000000000,0x000000030000000b,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x000000000000009b,0x000000000000004d,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000001,0x0000000000000000,0x0000000200000013,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x00000000000000e8,0x0000000000000018,0x0000000100000002\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000008,0x0000000000000018,0x0000000100000040,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000100,0x0000000000000000,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000001,0x0000000000000000,0x0000000400000006,0x0000000000000240\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x0000000000000070,0x0000000000000070\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000008,0x0000000400000001,0x0000000000000240,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000070,0x0000000000000070,0x0000000000000008\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000004001010002,0x00000000000002a8,0x0000000000000000,0x0000005900010007\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000011,0x0000000000000000,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x33010102464c457f,0x0000000000000007,0x0000007900be0002,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000238,0x00000000000000f8,0x0038004000590559,0x0001000500400002\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x7472747368732e00,0x747274732e006261,0x746d79732e006261,0x746d79732e006261\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x78646e68735f6261,0x7466752e766e2e00,0x2e007972746e652e,0x006f666e692e766e\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x665f67756265642e,0x732e0000656d6172,0x0062617472747368,0x006261747274732e\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x006261746d79732e,0x5f6261746d79732e,0x6e2e0078646e6873,0x6e652e7466752e76\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x2e766e2e00797274,0x65642e006f666e69,0x6d6172665f677562,0x0000000000000065\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x0000000000000000,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x0000000000000000,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x0000000000000000,0x0000000300000001\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x0000000000000040,0x000000000000004d\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000001,0x0000000000000000,0x000000030000000b\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x000000000000008d,0x000000000000004d\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000001,0x0000000000000000,0x0000000200000013\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x00000000000000e0,0x0000000000000018\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000100000002,0x0000000000000008,0x0000000000000018,0x0000000100000040\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x00000000000000f8,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000001,0x0000000000000000,0x0000000500000006\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000238,0x0000000000000000,0x0000000000000000,0x0000000000000070\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000070,0x0000000000000008,0x0000000500000001,0x0000000000000238\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000000,0x0000000000000000,0x0000000000000070,0x0000000000000070\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000008,0x0000004801010001,0x0000000000000038,0x0000004000000036\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000005900080001,0x0000000000000000,0x0000000000002011,0x0000000000000000\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000000000038,0x0000000000000000,0x762e21f000010a13,0x38206e6f69737265\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x677261742e0a312e,0x39385f6d73207465,0x7365726464612e0a,0x3620657a69735f73\n&quot;</span></span><br><span class="line"><span class="string">&quot;.quad 0x0000000a0a0a0a34\n&quot;</span></span><br><span class="line"><span class="string">&quot;.text\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> fatbinData[<span class="number">205</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> __fatBinC_Wrapper_t __fatDeviceText __attribute__ ((aligned (<span class="number">8</span>))) __attribute__ ((section (__CUDAFATBINSECTION)))= </span><br><span class="line">  &#123; <span class="number">0x466243b1</span>, <span class="number">1</span>, fatbinData, <span class="number">0</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;Line 73 定义的类型为 <code>__fatBinC_Wrapper_t</code> 的变量 <code>__fatDeviceText</code> 即是我们在 <code>main.fatbin.c</code> 的最终产物，可以观察到它最终被包括在了名为 <code>nvFatbinSegment</code> 的 section 中。<code>__fatBinC_Wrapper_t</code> 的结构体定义没有明确的文档说明，但可以参考 Yifan Sun <cite>stackoverflow_key</cite> 给出的逆向工程分析:

  <div class="code_segment">

  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="type">uint32_t</span> magic;     <span class="comment">// Always 0x466243b1</span></span><br><span class="line">  <span class="type">uint32_t</span> seq;       <span class="comment">// Sequence number of the cubin</span></span><br><span class="line">  <span class="type">uint64_t</span> ptr;       <span class="comment">// The pointer to the real cubin</span></span><br><span class="line">  <span class="type">uint64_t</span> data_ptr;  <span class="comment">// Some pointer related to the data segment</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;其首先包含一个 magic number <code>0x466243b1</code>；然后是当前 cubin 的序列号，当前是我们编译的第一个 cubin，因此其序列号为 1；然后是指向真正 cubin 的指针，在 <coderef>main_fatbin_c</coderef> 中我们可以看见 cubin 程序又被包括在了 <code>.nv_fatbin</code> section 中；最后是一个指向 data segment 的指针，<coderef>main_fatbin_c</coderef> 中是一个 null 指针。

  <h3 class="title">生成目标文件</h3>

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gcc -D__CUDA_ARCH__=890                                           \</span><br><span class="line">    -D__CUDA_ARCH_LIST__=890                                      \</span><br><span class="line">    -c                                                            \</span><br><span class="line">    -x c++                                                        \</span><br><span class="line">    -DCUDA_DOUBLE_MATH_FUNCTIONS                                  \</span><br><span class="line">    <span class="string">&quot;-I/usr/local/cuda-12.1/bin/../targets/x86_64-linux/include&quot;</span>  \</span><br><span class="line">    -m64 <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-6_main.cudafe1.cpp&quot;</span>       \</span><br><span class="line">    -o <span class="string">&quot;/tmp/tmpxft_0000047f_00000000-20_main.o&quot;</span></span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;运行了上述命令后，文件夹结构如下所示:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line"><span class="comment"># ├── gemm_kernel.cuh</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_1.cu</span></span><br><span class="line"><span class="comment"># ├── gemm_kernel_2.cu</span></span><br><span class="line"><span class="comment"># ├── main.cu</span></span><br><span class="line">  └── tmp</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-17_main.cpp1.ii</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-18_main.sm_90.cubin</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-19_main.sm_89.cubin</span></span><br><span class="line">       ├── tmpxft_0000047f_00000000-20_main.o</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-3_main.fatbin.c</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-4_main.module_id</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-5_main.cpp4.ii</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.c</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.cpp</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.gpu</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000047f_00000000-6_main.cudafe1.stub.c</span></span><br><span class="line"><span class="comment">#      └── tmpxft_0000047f_00000000-6_main.ptx</span></span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;上述命令是一个 <code>gcc -c</code> 指令，代表着该指令完成了编译，但是还没有进行链接。其完成了对 <code>main.cudafe1.cpp</code> 文件的编译过程（生成自 <coderef>cudafe1_cpp</coderef>），也即编译了 host 侧和 device 侧的程序，但暂未完成跨文件符号的链接操作。

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -s ./tmp/tmpxft_0000356e_00000000-11_main.o</span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;通过运行以上命令，我们可以看到编译得到的目标文件中的 section 分布情况，如 <coderef>main_o_sections</coderef> 所示。

  <div class="code_segment" label="main_o_sections">

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line">./tmp/tmpxft_0000047f_00000000-20_main.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">Contents of section .group:</span><br><span class="line">0000 01000000 06000000                    ........        </span><br><span class="line"></span><br><span class="line">Contents of section .text:</span><br><span class="line">0000 f30f1efa 554889e5 48897df8 488b45f8  ....UH..H.&#125;.H.E.</span><br><span class="line">0010 48890500 00000090 5dc3f30f 1efa5548  H.......].....UH</span><br><span class="line">0020 89e55348 83ec7864 488b0425 28000000  ..SH..xdH..%(...</span><br><span class="line">0030 488945e8 31c0c745 94400000 00c74598  H.E.1..E.@....E.</span><br><span class="line">0040 80000000 c7459c20 00000048 c745a000  .....E. ...H.E..</span><br><span class="line">0050 00000048 c745a800 00000048 c745b000  ...H.E.....H.E..</span><br><span class="line">0060 00000048 c745b800 00000048 c745c000  ...H.E.....H.E..</span><br><span class="line">0070 00000048 c745c800 0000008b 45940faf  ...H.E......E...</span><br><span class="line">0080 45984898 488d1485 00000000 488d45a0  E.H.H.......H.E.</span><br><span class="line">0090 4889d648 89c7e800 00000048 8b45a048  H..H.......H.E.H</span><br><span class="line">00a0 85c0751e 488d0500 00000048 89c7b800  ..u.H......H....</span><br><span class="line">00b0 000000e8 00000000 b8ffffff ffe9a303  ................</span><br><span class="line">00c0 00008b45 980faf45 9c489848 8d148500  ...E...E.H.H....</span><br><span class="line">00d0 00000048 8d45a848 89d64889 c7e80000  ...H.E.H..H.....</span><br><span class="line">00e0 0000488b 45a84885 c0751e48 8d050000  ..H.E.H..u.H....</span><br><span class="line">00f0 00004889 c7b80000 0000e800 000000b8  ..H.............</span><br><span class="line">0100 ffffffff e95c0300 008b4594 0faf459c  .....\....E...E.</span><br><span class="line">0110 4898488d 14850000 0000488d 45b04889  H.H.......H.E.H.</span><br><span class="line">0120 d64889c7 e8000000 00488b45 b04885c0  .H.......H.E.H..</span><br><span class="line">0130 751e488d 05000000 004889c7 b8000000  u.H......H......</span><br><span class="line">0140 00e80000 0000b8ff ffffffe9 15030000  ................</span><br><span class="line">0150 8b45940f af459848 9848c1e0 024889c7  .E...E.H.H...H..</span><br><span class="line">0160 e8000000 00488945 b848837d b800751e  .....H.E.H.&#125;..u.</span><br><span class="line">0170 488d0500 00000048 89c7b800 000000e8  H......H........</span><br><span class="line">0180 00000000 b8ffffff ffe9d702 0000c745  ...............E</span><br><span class="line">0190 8c000000 00eb208b 458c4898 488d1485  ...... .E.H.H...</span><br><span class="line">01a0 00000000 488b45b8 488d1c02 e8000000  ....H.E.H.......</span><br><span class="line">01b0 00890383 458c018b 45940faf 45983945  ....E...E...E.9E</span><br><span class="line">01c0 8c7cd48b 45980faf 459c4898 48c1e002  .|..E...E.H.H...</span><br><span class="line">01d0 4889c7e8 00000000 488945c0 48837dc0  H.......H.E.H.&#125;.</span><br><span class="line">01e0 00751e48 8d050000 00004889 c7b80000  .u.H......H.....</span><br><span class="line">01f0 0000e800 000000b8 ffffffff e9640200  .............d..</span><br><span class="line">0200 00c74590 00000000 eb208b45 90489848  ..E...... .E.H.H</span><br><span class="line">0210 8d148500 00000048 8b45c048 8d1c02e8  .......H.E.H....</span><br><span class="line">0220 00000000 89038345 90018b45 980faf45  .......E...E...E</span><br><span class="line">0230 9c394590 7cd48b45 940faf45 9c489848  .9E.|..E...E.H.H</span><br><span class="line">0240 c1e00248 89c7e800 00000048 8945c848  ...H.......H.E.H</span><br><span class="line">0250 837dc800 751e488d 05000000 004889c7  .&#125;..u.H......H..</span><br><span class="line">0260 b8000000 00e80000 0000b8ff ffffffe9  ................</span><br><span class="line">0270 f1010000 8b45940f af459848 98488d14  .....E...E.H.H..</span><br><span class="line">0280 85000000 00488b45 a0488b75 b8b90100  .....H.E.H.u....</span><br><span class="line">0290 00004889 c7e80000 00008b45 980faf45  ..H........E...E</span><br><span class="line">02a0 9c489848 8d148500 00000048 8b45a848  .H.H.......H.E.H</span><br><span class="line">02b0 8b75c0b9 01000000 4889c7e8 00000000  .u......H.......</span><br><span class="line">02c0 488d45dc b9010000 00ba0100 0000be00  H.E.............</span><br><span class="line">02d0 01000048 89c7e800 00000048 8d45d0b9  ...H.......H.E..</span><br><span class="line">02e0 01000000 ba010000 00be0100 00004889  ..............H.</span><br><span class="line">02f0 c7e80000 0000488b 45dc8b4d e44889ca  ......H.E..M.H..</span><br><span class="line">0300 488b7dd0 8b75d841 b9000000 0041b800  H.&#125;..u.A.....A..</span><br><span class="line">0310 00000048 89d14889 c2e80000 000085c0  ...H..H.........</span><br><span class="line">0320 7524488b 55b0488b 75a8488b 45a0448b  u<span class="variable">$H</span>.U.H.u.H.E.D.</span><br><span class="line">0330 459c8b7d 988b4d94 4589c141 89f84889  E..&#125;..M.E..A..H.</span><br><span class="line">0340 c7e80000 00008b45 940faf45 9c489848  .......E...E.H.H</span><br><span class="line">0350 8d148500 00000048 8b75b048 8b45c8b9  .......H.u.H.E..</span><br><span class="line">0360 02000000 4889c7e8 00000000 488d45dc  ....H.......H.E.</span><br><span class="line">0370 b9010000 00ba0100 0000be00 01000048  ...............H</span><br><span class="line">0380 89c7e800 00000048 8d45d0b9 01000000  .......H.E......</span><br><span class="line">0390 ba010000 00be0100 00004889 c7e80000  ..........H.....</span><br><span class="line">03a0 0000488b 45dc8b4d e44889ca 488b7dd0  ..H.E..M.H..H.&#125;.</span><br><span class="line">03b0 8b75d841 b9000000 0041b800 00000048  .u.A.....A.....H</span><br><span class="line">03c0 89d14889 c2e80000 000085c0 7524488b  ..H.........u<span class="variable">$H</span>.</span><br><span class="line">03d0 55b0488b 75a8488b 45a0448b 459c8b7d  U.H.u.H.E.D.E..&#125;</span><br><span class="line">03e0 988b4d94 4589c141 89f84889 c7e80000  ..M.E..A..H.....</span><br><span class="line">03f0 00008b45 940faf45 9c489848 8d148500  ...E...E.H.H....</span><br><span class="line">0400 00000048 8b75b048 8b45c8b9 02000000  ...H.u.H.E......</span><br><span class="line">0410 4889c7e8 00000000 488b45a0 4889c7e8  H.......H.E.H...</span><br><span class="line">0420 00000000 488b45a8 4889c7e8 00000000  ....H.E.H.......</span><br><span class="line">0430 488b45b0 4889c7e8 00000000 488b45b8  H.E.H.......H.E.</span><br><span class="line">0440 4889c7e8 00000000 488b45c0 4889c7e8  H.......H.E.H...</span><br><span class="line">0450 00000000 488b45c8 4889c7e8 00000000  ....H.E.H.......</span><br><span class="line">0460 b8000000 00488b55 e864482b 14252800  .....H.U.dH+.%(.</span><br><span class="line">0470 00007405 e8000000 00488b5d f8c9c3f3  ..t......H.]....</span><br><span class="line">0480 0f1efa55 4889e548 897df848 8b45f848  ...UH..H.&#125;.H.E.H</span><br><span class="line">0490 89050000 00005dc3 f30f1efa 554889e5  ......].....UH..</span><br><span class="line">04a0 488d0500 00000048 89c7e8d0 ffffff48  H......H.......H</span><br><span class="line">04b0 8b050000 00004889 c7e80000 0000905d  ......H........]</span><br><span class="line">04c0 c3f30f1e fa554889 e54883ec 1048897d  .....UH..H...H.&#125;</span><br><span class="line">04d0 f8488b45 f84889c7 e8000000 00c9c3f3  .H.E.H..........</span><br><span class="line">04e0 0f1efa55 4889e548 83ec0848 897df848  ...UH..H...H.&#125;.H</span><br><span class="line">04f0 8b45f848 89050000 0000488b 45f84889  .E.H......H.E.H.</span><br><span class="line">0500 c7e8fafa ffff90c9 c3f30f1e fa554889  .............UH.</span><br><span class="line">0510 e54883ec 10488d05 00000000 4889c7e8  .H...H......H...</span><br><span class="line">0520 00000000 48890500 00000048 8d05adff  ....H......H....</span><br><span class="line">0530 ffff4889 45f8488b 55f8488b 05000000  ..H.E.H.U.H.....</span><br><span class="line">0540 004889c7 ffd2488b 05000000 004889c7  .H....H......H..</span><br><span class="line">0550 e8000000 00488d05 3cffffff 4889c7e8  .....H..&lt;...H...</span><br><span class="line">0560 00000000 90c9c3                      .......         </span><br><span class="line"></span><br><span class="line">Contents of section .text._ZN4dim3C2Ejjj:</span><br><span class="line">0000 f30f1efa 554889e5 48897df8 8975f489  ....UH..H.&#125;..u..</span><br><span class="line">0010 55f0894d ec488b45 f88b55f4 8910488b  U..M.H.E..U...H.</span><br><span class="line">0020 45f88b55 f0895004 488b45f8 8b55ec89  E..U..P.H.E..U..</span><br><span class="line">0030 5008905d c3                          P..].           </span><br><span class="line"></span><br><span class="line">Contents of section .rodata:</span><br><span class="line">0000 47505520 616c6c6f 63206661 696c0043  GPU alloc fail.C</span><br><span class="line">0010 50552061 6c6c6f63 20666169 6c00      PU alloc fail.  </span><br><span class="line"></span><br><span class="line">Contents of section __nv_module_id:</span><br><span class="line">0000 5f5f4e56 5f4d4f44 554c455f 494400    __NV_MODULE_ID. </span><br><span class="line"></span><br><span class="line">Contents of section .nv_fatbin:</span><br><span class="line">0000 50ed55ba 01001000 58060000 00000000  P.U.....X.......</span><br><span class="line">0010 02000101 40000000 b0020000 00000000  ....@...........</span><br><span class="line">0020 00000000 00000000 07000100 5a000000  ............Z...</span><br><span class="line">0030 00000000 00000000 11000000 00000000  ................</span><br><span class="line">0040 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0050 7f454c46 02010133 07000000 00000000  .ELF...3........</span><br><span class="line">0060 0200be00 79000000 00000000 00000000  ....y...........</span><br><span class="line">0070 40020000 00000000 00010000 00000000  @...............</span><br><span class="line">0080 5a055900 40003800 02004000 05000100  Z.Y.@.8...@.....</span><br><span class="line">0090 002e7368 73747274 6162002e 73747274  ..shstrtab..strt</span><br><span class="line">00a0 6162002e 73796d74 6162002e 73796d74  ab..symtab..symt</span><br><span class="line">00b0 61625f73 686e6478 002e6e76 2e756674  ab_shndx..nv.uft</span><br><span class="line">00c0 2e656e74 7279002e 6e762e69 6e666f00  .entry..nv.info.</span><br><span class="line">00d0 2e646562 75675f66 72616d65 00000000  .debug_frame....</span><br><span class="line">00e0 00000000 00000000 00000000 2e736873  .............shs</span><br><span class="line">00f0 74727461 62002e73 74727461 62002e73  trtab..strtab..s</span><br><span class="line">0100 796d7461 62002e73 796d7461 625f7368  ymtab..symtab_sh</span><br><span class="line">0110 6e647800 2e6e762e 7566742e 656e7472  ndx..nv.uft.entr</span><br><span class="line">0120 79002e6e 762e696e 666f002e 64656275  y..nv.info..debu</span><br><span class="line">0130 675f6672 616d6500 00000000 00000000  g_frame.........</span><br><span class="line">0140 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0150 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0160 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0170 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0180 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0190 01000000 03000000 00000000 00000000  ................</span><br><span class="line">01a0 00000000 00000000 40000000 00000000  ........@.......</span><br><span class="line">01b0 4d000000 00000000 00000000 00000000  M...............</span><br><span class="line">01c0 01000000 00000000 00000000 00000000  ................</span><br><span class="line">01d0 0b000000 03000000 00000000 00000000  ................</span><br><span class="line">01e0 00000000 00000000 9b000000 00000000  ................</span><br><span class="line">01f0 4d000000 00000000 00000000 00000000  M...............</span><br><span class="line">0200 01000000 00000000 00000000 00000000  ................</span><br><span class="line">0210 13000000 02000000 00000000 00000000  ................</span><br><span class="line">0220 00000000 00000000 e8000000 00000000  ................</span><br><span class="line">0230 18000000 00000000 02000000 01000000  ................</span><br><span class="line">0240 08000000 00000000 18000000 00000000  ................</span><br><span class="line">0250 40000000 01000000 00000000 00000000  @...............</span><br><span class="line">0260 00000000 00000000 00010000 00000000  ................</span><br><span class="line">0270 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0280 01000000 00000000 00000000 00000000  ................</span><br><span class="line">0290 06000000 04000000 40020000 00000000  ........@.......</span><br><span class="line">02a0 00000000 00000000 00000000 00000000  ................</span><br><span class="line">02b0 70000000 00000000 70000000 00000000  p.......p.......</span><br><span class="line">02c0 08000000 00000000 01000000 04000000  ................</span><br><span class="line">02d0 40020000 00000000 00000000 00000000  @...............</span><br><span class="line">02e0 00000000 00000000 70000000 00000000  ........p.......</span><br><span class="line">02f0 70000000 00000000 08000000 00000000  p...............</span><br><span class="line">0300 02000101 40000000 a8020000 00000000  ....@...........</span><br><span class="line">0310 00000000 00000000 07000100 59000000  ............Y...</span><br><span class="line">0320 00000000 00000000 11000000 00000000  ................</span><br><span class="line">0330 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0340 7f454c46 02010133 07000000 00000000  .ELF...3........</span><br><span class="line">0350 0200be00 79000000 00000000 00000000  ....y...........</span><br><span class="line">0360 38020000 00000000 f8000000 00000000  8...............</span><br><span class="line">0370 59055900 40003800 02004000 05000100  Y.Y.@.8...@.....</span><br><span class="line">0380 002e7368 73747274 6162002e 73747274  ..shstrtab..strt</span><br><span class="line">0390 6162002e 73796d74 6162002e 73796d74  ab..symtab..symt</span><br><span class="line">03a0 61625f73 686e6478 002e6e76 2e756674  ab_shndx..nv.uft</span><br><span class="line">03b0 2e656e74 7279002e 6e762e69 6e666f00  .entry..nv.info.</span><br><span class="line">03c0 2e646562 75675f66 72616d65 00002e73  .debug_frame...s</span><br><span class="line">03d0 68737472 74616200 2e737472 74616200  hstrtab..strtab.</span><br><span class="line">03e0 2e73796d 74616200 2e73796d 7461625f  .symtab..symtab_</span><br><span class="line">03f0 73686e64 78002e6e 762e7566 742e656e  shndx..nv.uft.en</span><br><span class="line">0400 74727900 2e6e762e 696e666f 002e6465  try..nv.info..de</span><br><span class="line">0410 6275675f 6672616d 65000000 00000000  bug_frame.......</span><br><span class="line">0420 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0430 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0440 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0450 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0460 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0470 00000000 00000000 01000000 03000000  ................</span><br><span class="line">0480 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0490 40000000 00000000 4d000000 00000000  @.......M.......</span><br><span class="line">04a0 00000000 00000000 01000000 00000000  ................</span><br><span class="line">04b0 00000000 00000000 0b000000 03000000  ................</span><br><span class="line">04c0 00000000 00000000 00000000 00000000  ................</span><br><span class="line">04d0 8d000000 00000000 4d000000 00000000  ........M.......</span><br><span class="line">04e0 00000000 00000000 01000000 00000000  ................</span><br><span class="line">04f0 00000000 00000000 13000000 02000000  ................</span><br><span class="line">0500 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0510 e0000000 00000000 18000000 00000000  ................</span><br><span class="line">0520 02000000 01000000 08000000 00000000  ................</span><br><span class="line">0530 18000000 00000000 40000000 01000000  ........@.......</span><br><span class="line">0540 00000000 00000000 00000000 00000000  ................</span><br><span class="line">0550 f8000000 00000000 00000000 00000000  ................</span><br><span class="line">0560 00000000 00000000 01000000 00000000  ................</span><br><span class="line">0570 00000000 00000000 06000000 05000000  ................</span><br><span class="line">0580 38020000 00000000 00000000 00000000  8...............</span><br><span class="line">0590 00000000 00000000 70000000 00000000  ........p.......</span><br><span class="line">05a0 70000000 00000000 08000000 00000000  p...............</span><br><span class="line">05b0 01000000 05000000 38020000 00000000  ........8.......</span><br><span class="line">05c0 00000000 00000000 00000000 00000000  ................</span><br><span class="line">05d0 70000000 00000000 70000000 00000000  p.......p.......</span><br><span class="line">05e0 08000000 00000000 01000101 48000000  ............H...</span><br><span class="line">05f0 38000000 00000000 36000000 40000000  8.......6...@...</span><br><span class="line">0600 01000800 59000000 00000000 00000000  ....Y...........</span><br><span class="line">0610 11200000 00000000 00000000 00000000  . ..............</span><br><span class="line">0620 38000000 00000000 00000000 00000000  8...............</span><br><span class="line">0630 130a0100 f0212e76 65727369 6f6e2038  .....!.version 8</span><br><span class="line">0640 2e310a2e 74617267 65742073 6d5f3839  .1..target sm_89</span><br><span class="line">0650 0a2e6164 64726573 735f7369 7a652036  ..address_size 6</span><br><span class="line">0660 340a0a0a 0a000000                    4.......        </span><br><span class="line"></span><br><span class="line">Contents of section .nvFatBinSegment:</span><br><span class="line">0000 b1436246 01000000 00000000 00000000  .CbF............</span><br><span class="line">0010 00000000 00000000                    ........        </span><br><span class="line"></span><br><span class="line">Contents of section .init_array:</span><br><span class="line">0000 00000000 00000000                    ........        </span><br><span class="line"></span><br><span class="line">Contents of section .comment:</span><br><span class="line">0000 00474343 3a202855 62756e74 75203131  .GCC: (Ubuntu 11</span><br><span class="line">0010 2e342e30 2d317562 756e7475 317e3232  .4.0-1ubuntu1~22</span><br><span class="line">0020 2e303429 2031312e 342e3000           .04) 11.4.0.    </span><br><span class="line"></span><br><span class="line">Contents of section .note.gnu.property:</span><br><span class="line">0000 04000000 10000000 05000000 474e5500  ............GNU.</span><br><span class="line">0010 020000c0 04000000 03000000 00000000  ................</span><br><span class="line"></span><br><span class="line">Contents of section .eh_frame:</span><br><span class="line">0000 14000000 00000000 017a5200 01781001  .........zR..x..</span><br><span class="line">0010 1b0c0708 90010000 1c000000 1c000000  ................</span><br><span class="line">0020 00000000 1a000000 00450e10 8602430d  .........E....C.</span><br><span class="line">0030 06510c07 08000000 1c000000 3c000000  .Q..........&lt;...</span><br><span class="line">0040 00000000 35000000 00450e10 8602430d  ....5....E....C.</span><br><span class="line">0050 066c0c07 08000000 20000000 5c000000  .l...... ...\...</span><br><span class="line">0060 00000000 65040000 00450e10 8602430d  ....e....E....C.</span><br><span class="line">0070 06458303 0357040c 07080000 1c000000  .E...W..........</span><br><span class="line">0080 80000000 00000000 19000000 00450e10  .............E..</span><br><span class="line">0090 8602430d 06500c07 08000000 1c000000  ..C..P..........</span><br><span class="line">00a0 a0000000 00000000 29000000 00450e10  ........)....E..</span><br><span class="line">00b0 8602430d 06600c07 08000000 1c000000  ..C..`..........</span><br><span class="line">00c0 c0000000 00000000 1e000000 00450e10  .............E..</span><br><span class="line">00d0 8602430d 06550c07 08000000 1c000000  ..C..U..........</span><br><span class="line">00e0 e0000000 00000000 2a000000 00450e10  ........*....E..</span><br><span class="line">00f0 8602430d 06610c07 08000000 20000000  ..C..a...... ...</span><br><span class="line">0100 00010000 00000000 5e000000 00450e10  ........^....E..</span><br><span class="line">0110 8602430d 0602550c 07080000 00000000  ..C...U.........</span><br></pre></td></tr></table></figure>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;至此，我们完成了从 .cu 文件到 .o 文件的分析过程，但是由于我们在 <code>main.cu</code> 并没有定义 kernel，因此有一些细节我们实际上没能观察到，<ref>compile_gemm_kernel_1</ref> 中我们将以 <code>gemm_kernel_1.cu</code> 的编译过程为例，展示其与 <code>main.cu</code> 编译过程的区别。
</div>

<h2 class="title"><code>gemm_kernel_1.cu</code> 的编译</h2>
<div class="div_learning_post">
  <label class="title">compile_gemm_kernel_1</label>

  <div class="noteblock">
    <p>
    &nbsp;&nbsp;&nbsp;&nbsp;由于 <code>gemm_kernel_1.cu</code> 和 <code>gemm_kernel_2.cu</code> 两个文件的编译过程是完全一样的，所以以下只以 <code>gemm_kernel_1.cu</code> 为例。
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;<code>cudafe1.stub.c</code> 文件的内容如 <coderef>stub</coderef> 所示，Line 27~32 我们可以看见 <code>void sum(int *, int *, int *)</code> 接口的进一步定义，其实际上调用了在同文件下定义的 <code>__device_stub__Z3sumPiS_S_</code> 函数，Line 17~25 展示了后者的实现细节，其使用了 <code>__cudaLaunchPrologue</code>、<code>__cudaSetupArgSimple</code> 和 <code>__cudaLaunch</code> 三个宏，这三个宏的定义如下所示:

  <div class="code_segment" file="crt/host_runtime.h" label="crt_host_runtime_h">

  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __cudaLaunchPrologue(size) \</span></span><br><span class="line"><span class="meta">        void * __args_arr[size]; \</span></span><br><span class="line"><span class="meta">        int __args_idx = 0</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __cudaSetupArg(arg, offset) \</span></span><br><span class="line"><span class="meta">        __args_arr[__args_idx] = (void *)__cudaAddressOf(arg); ++__args_idx</span></span><br><span class="line">          </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __cudaSetupArgSimple(arg, offset) \</span></span><br><span class="line"><span class="meta">        __args_arr[__args_idx] = (void *)(char *)&amp;arg; ++__args_idx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* the use of __args_idx in the expression below avoids host compiler warning about it being an</span></span><br><span class="line"><span class="comment">  unused variable when the launch has no arguments */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __cudaLaunch(fun) \</span></span><br><span class="line"><span class="meta">  &#123; volatile static char *__f __NV_ATTR_UNUSED_FOR_LAUNCH;  __f = fun; \</span></span><br><span class="line"><span class="meta">    dim3 __gridDim, __blockDim;\</span></span><br><span class="line"><span class="meta">    size_t __sharedMem; \</span></span><br><span class="line"><span class="meta">    cudaStream_t __stream; \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__cudaPopCallConfiguration(&amp;__gridDim, &amp;__blockDim, &amp;__sharedMem, &amp;__stream) != cudaSuccess) \</span></span><br><span class="line"><span class="meta">      return; \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__args_idx == 0) &#123;\</span></span><br><span class="line"><span class="meta">      (void)cudaLaunchKernel(fun, __gridDim, __blockDim, &amp;__args_arr[__args_idx], __sharedMem, __stream);\</span></span><br><span class="line"><span class="meta">    &#125; <span class="keyword">else</span> &#123; \</span></span><br><span class="line"><span class="meta">      (void)cudaLaunchKernel(fun, __gridDim, __blockDim, &amp;__args_arr[0], __sharedMem, __stream);\</span></span><br><span class="line"><span class="meta">    &#125;\</span></span><br><span class="line"><span class="meta">  &#125;</span></span><br></pre></td></tr></table></figure>
  </div>


  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;因此，<code>void sum(int *, int *, int *)</code> 接口的行为实际上是，先使用 <code>__cudaLaunchPrologue</code> 宏，初始化出一个长度与 kernel 参数列表长度相同的数组，然后使用 <code>__cudaSetupArgSimple</code> 宏向数组中填充参数，最后调用 <code>__cudaLaunch</code> 宏启动 kernel。<code>__cudaLaunch</code> 中则实际上显示调用 <code>__cudaPopCallConfiguration</code>，将我们在 <coderef>cudafe1_cpp</coderef> 中看到的使用 <code>__cudaPushCallConfiguration</code> 压入 CUDA Runtime 中维护的某个 stack 的 kernel 调用参数 (i.e., gridDim, blockDim, sharedMem, stream) 重新弹出来，最后再调用 <code>cudaLaunchKernel</code> 启动对应的 kernel。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;最后在 <coderef>stub</coderef> 中还有值得深挖的一层: 在 Line 15 中我们可以看到有一个标记了 <code>__attribute__((__constructor__))</code> 的函数 <code>__sti____cudaRegisterAll</code>，也就是说它在程序启动时就会被自动执行。这个函数的定义可以在 Line 46~48 中找到，可以看到其实际上调用了 <code>__cudaRegisterBinary</code>，根据名字推测，其用于向 device 注册 cuda 二进制，其实际上调用了 <code>__cudaRegisterEntry</code> (Line 38) 完成了对 <code>sum</code> 这个 kernel 的注册工作。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;这里有一个有趣的地方：上面我们看到的 <code>cudaLaunchKernel</code> 和 <code>__cudaRegisterEntry</code> 接口，它都接受了 <code>void sum(int *, int *, int *)</code> 接口的函数地址作为参数。细心的读者可能会有疑问：<code>void sum(int *, int *, int *)</code> 接口不是给 Host 侧 C++ 代码使用的么？为什么注册和发射 kernel 也用它来作为参数？实际上此时 <code>void sum(int *, int *, int *)</code> 的函数指针是被 CUDA Runtime 当作 key 来使用的 <cite>stackoverflow_key</cite>，在 Line 38~43 我们可以看见 <code>__cudaRegisterEntry</code> 的参数列表中有两个重要参数: 一个是 <code>void sum(int *, int *, int *)</code> 的函数指针，另一个名为 <code>_Z3sumPiS_S_</code> 的名称我们可以在 <coderef>main_ptx</coderef> 的 Line 15 中看到，其是 sum kernel 对应的 PTX entry 的名字。<code>__cudaRegisterEntry</code> 这里相当于在内部维护了一个映射：当 <code>cudaLaunchKernel</code> 尝试使用 <code>void sum(int *, int *, int *)</code> 的函数指针发射 kernel 时，Runtime 就知道用户想要运行的是 <code>_Z3sumPiS_S_</code> 对应的程序了。
</div>


<h2 class="title">合并多个 <code>.cu</code> 文件</h2>
<div class="div_learning_post">
  <h3 class="title">链接</h3>

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nvlink  -m64 --<span class="built_in">arch</span>=sm_52                                                                   \</span><br><span class="line">        --register-link-binaries=<span class="string">&quot;/tmp/tmpxft_0000356e_00000000-7_staticthread_dlink.reg.c&quot;</span> \</span><br><span class="line">        <span class="string">&quot;-L/usr/local/cuda-12.1/bin/../targets/x86_64-linux/lib/stubs&quot;</span>                      \  </span><br><span class="line">        <span class="string">&quot;-L/usr/local/cuda-12.1/bin/../targets/x86_64-linux/lib&quot;</span>                            \</span><br><span class="line">        -cpu-arch=X86_64                                                                    \</span><br><span class="line">        <span class="string">&quot;./tmp/tmpxft_0000356e_00000000-11_main.o&quot;</span>                                          \</span><br><span class="line">        -lcudadevrt                                                                         \</span><br><span class="line">        -o <span class="string">&quot;./tmp/tmpxft_0000356e_00000000-12_staticthread_dlink.sm_52.cubin&quot;</span>               \</span><br><span class="line">        --host-ccbin <span class="string">&quot;gcc&quot;</span></span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;运行了上述命令后，文件夹结构如下所示:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line"><span class="comment"># ├── main.cu</span></span><br><span class="line">  └── tmp</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000356e_00000000-10_main.sm_52.cubin</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000356e_00000000-11_main.o</span></span><br><span class="line">       ├── tmpxft_0000356e_00000000-12_staticthread_dlink.sm_52.cubin</span><br><span class="line"><span class="comment">#      ├── tmpxft_0000356e_00000000-3_main.fatbin.c</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000356e_00000000-4_main.module_id</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000356e_00000000-5_main.cpp4.ii</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000356e_00000000-6_main.cudafe1.c</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000356e_00000000-6_main.cudafe1.cpp</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000356e_00000000-6_main.cudafe1.gpu</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000356e_00000000-6_main.cudafe1.stub.c</span></span><br><span class="line"><span class="comment">#      ├── tmpxft_0000356e_00000000-6_main.ptx</span></span><br><span class="line">       ├── tmpxft_0000356e_00000000-7_staticthread_dlink.reg.c</span><br><span class="line"><span class="comment">#      └── tmpxft_0000356e_00000000-9_main.cpp1.ii</span></span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;新增加的文件中，<code>staticthread_dlink.sm_52.cubin</code> 包含了 <code>nvlink</code> 输入的所有目标文件中 Device 侧程序 (i.e., PTX 和 SASS) 的集合，我们此处只有一个目标文件，因此 <code>staticthread_dlink.sm_52.cubin</code> 只包含了前面我们处理过的 <code>main.cu</code> 中包含的 Device 侧程序；<code>staticthread_dlink.reg.c</code> 

  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_PRELINKED_OBJECTS 0</span></span><br></pre></td></tr></table></figure>
</div>


<div class="div_ref" id="ref_container"></div>

</body>

<!-- 代码块 -->
<!-- <div class="code_segment" label="forward">

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* hello*/</span></span><br></pre></td></tr></table></figure>
</div> -->

<!-- 代码块引用 -->
<!-- <coderef>forward</coderef> -->

<!-- Comment -->
<!-- <div class="comblock" title="xxx"> -->

<!-- Chart Support -->
<!-- Check https://www.runoob.com/chartjs/chartjs-tutorial.html -->
<!-- <div class="chartjs" label="naive_impt_performance"></div> -->

<!-- Note Support -->
<!-- Check https://theme-next.js.org/docs/tag-plugins/note.html -->

<!-- 圆圈数字 -->
<!--
⓪ ① ② ③ ④ ⑤ ⑥ ⑦ ⑧ ⑨ ⑩ ⑪ ⑫ ⑬ ⑭ ⑮ ⑯ ⑰ ⑱ ⑲ ⑳ ㉑ ㉒ ㉓ ㉔ ㉕ ㉖ ㉗ ㉘ ㉙ ㉚ ㉛ ㉜ ㉝ ㉞ ㉟ ㊱ ㊲ ㊳ ㊴ ㊵ ㊶ ㊷ ㊸ ㊹ ㊺ ㊻ ㊼ ㊽ ㊾ ㊿
-->

<!-- Flow Chart -->
<!--
Format see: https://mermaid-js.github.io/mermaid/#/flowchart
-->
<!-- <flowchart class="mermaid">
 Mermaid Flow Chart Code
</flowchart> -->

<!-- Sign Block -->
<!--
<div class="noteblock">
A NOTE
</div>

<div class="queblock">
A QUESTION
</div>
-->

<!--图片、引用-->
<!-- 
<div class="img" title="img title" label="img_label" source="url">
  <img src="" height="" />
</div>

<imaging>img_label</imaging>
-->

<!--等式、引用-->
<!-- 
<div class="equation" label="equation_label">
</div>

<equation>equation_label</equation>
-->

<!--定理、引用、证明-->
<!-- 
<div class="theorm" label="theorm_label">
</div>

<theorm>theorm_label</theorm>

<div class="theorm_prove">
</div>
-->

<!--引用其它章节-->
<!-- 
<ref></ref> 
-->

<!--引用文献-->
<!-- 
<cite></cite> 
-->

<!--关键词-->
<!-- 
<def></def> 
-->

<!--醒目注意-->
<!-- 
<note></note> 
-->

<!--段落-->
<!--
<h3 class="paragraph">Paragraph Name</h3>
-->

<!--表格-->
<!--
<div class="table" title="Table Title" label="table_label">
  <table border="1" align="center" bgcolor="#FFFFFF">
    <tr>
      <th>A</th>
      <th>B</th>
      <th>C</th>
    </tr>
    <tr>
      <td>xxx</td>
      <td>xxx</td>
      <td>xxx</td>
    </tr>
  </table>
</div>
-->

<!--矩阵公式-->
<!--
<div class="cmath" align="center">
  `((1, 0),(1, 0))`
</div><br>
-->

<!--伪代码-->
<!--
<pre id="quicksort" style="display:hidden;">
  % This quicksort algorithm is extracted from Chapter 7, Introduction to Algorithms (3rd edition)
  \begin{algorithm}
  \caption{Quicksort}
  \begin{algorithmic}
  \PROCEDURE{Quicksort}{$A, p, r$}
      % Add Here

      % 空行
      % \STATE \texttt{\\}
  \ENDPROCEDURE
  \end{algorithmic}
  \end{algorithm}
</pre>
<script>
    pseudocode.renderElement(document.getElementById("quicksort"));
</script>
-->
<!--
Latex 伪代码格式见: https://github.com/SaswatPadhi/pseudocode.js
-->

<!--图片-->
<!--
<div align="center">
  <img src="./pic/xxx.png" width=80%>
</div>
-->

<!--正文-->
<!--
<p>
&nbsp;&nbsp;&nbsp;&nbsp;公式：<span>`\overline{A}\overline{B}`</span>
</p>
-->
      </div>
      
      
      
    </div>
    
  <ul class="breadcrumb">
          
            <li><a href="/sec_learning/">SEC_LEARNING</a></li>
            <li><a href="/sec_learning/Tech_OS_And_Linux_Kernel/">TECH_OS_AND_LINUX_KERNEL</a></li>
          <li>CUDA_NVCC_COMPILATION</li>
        
  </ul>

    
    
    


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zhuobin Huang"
      src="/images/avatar_2.png">
  <p class="site-author-name" itemprop="name">Zhuobin Huang</p>
  <div class="site-description" itemprop="description">System Engineer</div>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zobinHuang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zobinHuang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zobin1999@gmail.com" title="E-Mail → mailto:zobin1999@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhuobin Huang</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
