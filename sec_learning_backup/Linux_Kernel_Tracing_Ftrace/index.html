<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Exo 2:300,300italic,400,400italic,700,700italic|Caveat:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zobinhuang.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":180,"display":"post","padding":10,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="MathJax &#x3D; {         tex: {             inlineMath: [[&#39;$&#39;,&#39;$&#39;], [&#39;\\(&#39;,&#39;\\)&#39;]],             displayMath: [[&#39;$$&#39;,&#39;$$&#39;], [&#39;\\[&#39;,&#39;\\]&#39;]],             processEscapes: true,             process">
<meta property="og:type" content="website">
<meta property="og:title" content="内核调试工具：Ftrace 的介绍和使用">
<meta property="og:url" content="https://zobinhuang.github.io/sec_learning_backup/Linux_Kernel_Tracing_Ftrace/index.html">
<meta property="og:site_name" content="Zobin">
<meta property="og:description" content="MathJax &#x3D; {         tex: {             inlineMath: [[&#39;$&#39;,&#39;$&#39;], [&#39;\\(&#39;,&#39;\\)&#39;]],             displayMath: [[&#39;$$&#39;,&#39;$$&#39;], [&#39;\\[&#39;,&#39;\\]&#39;]],             processEscapes: true,             process">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png">
<meta property="og:image" content="https://zobinhuang.github.io/sec_learning_backup/Linux_Kernel_Tracing_Ftrace/pic/frame_graph_exp.svg">
<meta property="og:image" content="https://zobinhuang.github.io/sec_learning_backup/Linux_Kernel_Tracing_Ftrace/pic/ftrace_arch.png">
<meta property="og:image" content="https://zobinhuang.github.io/sec_learning_backup/Linux_Kernel_Tracing_Ftrace/pic/ftrace_tracer.png">
<meta property="og:image" content="https://zobinhuang.github.io/sec_learning_backup/Linux_Kernel_Tracing_Ftrace/pic/xxx.png">
<meta property="article:published_time" content="2022-03-20T10:23:22.826Z">
<meta property="article:modified_time" content="2022-03-20T10:23:22.826Z">
<meta property="article:author" content="Zhuobin Huang">
<meta property="article:tag" content="Zobin">
<meta property="article:tag" content="黄卓彬">
<meta property="article:tag" content="zobinHuang">
<meta property="article:tag" content="网络工程">
<meta property="article:tag" content="Networking Engineering">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png">

<link rel="canonical" href="https://zobinhuang.github.io/sec_learning_backup/Linux_Kernel_Tracing_Ftrace/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>内核调试工具：Ftrace 的介绍和使用 | Zobin
</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Zobin" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zobin</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Lovin' Tech with Tea</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about-me-(关于我)">

    <a href="/sec_about/" rel="section"><i class="fa fa-user fa-fw"></i>About Me (关于我)</a>

  </li>
        <li class="menu-item menu-item-library-(知识库)">

    <a href="/sec_learning/" rel="section"><i class="fa fa-duotone fa-book fa-fw"></i>Library (知识库)</a>

  </li>
        <li class="menu-item menu-item-music-(独立音乐人)">

    <a href="/sec_music/" rel="section"><i class="fa fa-music fa-fw"></i>Music (独立音乐人)</a>

  </li>
        <li class="menu-item menu-item-thoughts-(想法)">

    <a href="/sec_thoughts/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Thoughts (想法)</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
  
  

          <div class="content page posts-expand">
            

    
    
    
    <div class="post-block" lang="en">
      <header class="post-header">

<h1 class="post-title" itemprop="name headline">内核调试工具：Ftrace 的介绍和使用
</h1>

<div class="post-meta">
  
  <ul class="breadcrumb">
          
            <li><a href="/sec_learning_backup/">SEC_LEARNING_BACKUP</a></li>
          <li>LINUX_KERNEL_TRACING_FTRACE</li>
        
  </ul>

</div>

</header>

      
      
      
      <div class="post-body">
          <head>
<!--导入样式表-->
<link rel="stylesheet" type="text/css" href="style/index.css">

<!--导入网页脚本-->
<script src="script/index.js"></script>

<!--支持伪代码显示-->
<script>
    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-chtml.js"
        integrity="sha256-3Fdoa5wQb+JYfEmTpQHx9sc/GuwpfC/0R9EpBki+mf8=" crossorigin>
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js">
</script>

<!--支持网页公式显示-->    
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>

<!--支持矩阵显示-->
<script type="text/javascript">
  run_maths = function() {
    if (document.querySelector('[class*="cmath"]') !== null) {
      if (typeof (mjax_path)=='undefined') { mjax_path='https://cdn.jsdelivr.net/npm/mathjax@2'; }
      if (typeof (mjax_config)=='undefined') { mjax_config='AM_CHTML'; }
      smjax = document.createElement ('script');
      smjax.setAttribute('src',`${mjax_path}/MathJax.js?config=${mjax_config}`);
      smjax.setAttribute('async',true);
      document.getElementsByTagName('head')[0].appendChild(smjax);
    }
  };
  if (document.readyState === 'loading') {  
    window.addEventListener('DOMContentLoaded', run_maths); 
  } else { 
    run_maths(); 
  }
</script>
</head>

<body onload="load_page()">

<div align="center" class="div_indicate_source">
  <h4>⚠ 转载请注明出处：<font color="red"><i>作者：ZobinHuang，更新日期：Jan.30 2022</i></font></h4>
</div>
<div class="div_licence">
  <br>
  <div align="center">
      <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="知识共享许可协议" style="border-width:0; margin-left: 20px; margin-right: 20px;" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" /></a>
  </div>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;本<span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" rel="dct:type">作品</span>由 <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName"><b>ZobinHuang</b></span> 采用 <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><font color="red">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</font></a> 进行许可，在进行使用或分享前请查看权限要求。若发现侵权行为，会采取法律手段维护作者正当合法权益，谢谢配合。
  </p>
</div>
<br>
<div class="div_catalogue">
  <div align="center">
    <h1> 目录 </h1>
    <p>
    <font size="3px">有特定需要的内容直接跳转到相关章节查看即可。</font>
  </div>
  <div class="div_load_catalogue_alert" id="load_catalogue_alert">正在加载目录...</div>
  <div class="div_catalogue_container" id="catalogue_container">
  </div>
</div><br>

<!-- Start your post here -->
<h2 class="title">何为 Trace 和 Profile?</h2>
<div class="div_learning_post"> 
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;<cite>so_profiling_and_tracing</cite>, <cite>book_system_performance</cite> 就系统性能的分析而言，可以分为两个不同的动作：<def>Profiling (分析)</def> 和 <def>Tracing (追踪)</def>。

  <h3 class="title">Profiling</h3>
  <div align="center">
    <img src="./pic/frame_graph_exp.svg" width=600px>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;Profiling 可以理解为从系统中收集 (采样) 运行过程中的信息 (e.g. 比如运行时间等)，然后从中发现系统运行瓶颈等信息。如上图所示的是 <def>Frame Graph (火焰图)</def> —— 一种对 CPU Profile 结果的展示方式。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;本文介绍的 Ftrace，就带有 Profiling 的功能。

  <h3 class="title">Tracing</h3>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;而 Tracing 可以理解为追踪任务运行的流程，例如我们可以使用 <code>strace</code> 来跟踪 System Call 的调用，使用 <code>tcpdump</code> 来追踪网络数据包的发送和到达等。我们可以把 Tracing 分为以下的两类:

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;<def>Static Instrumentation</def> (静态仪表): 指的是在源代码中加入的一些追踪代码，在 Linux 内核中有大量的静态仪表，用以测量磁盘 I/O, 调度事件，系统调用等，Linux 内核把这类代码称为 <def>tracepoint</def>。不仅内核，用户态程序也可以进行静态追踪，即 <def>User Statically Defined Tracing (USDT)</def>。USDT 被像 <code>libc</code> 等库用于追踪用户程序对库函数的调用。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;<def>Dynamic Instrumentation</def> (动态仪表): 指的是在程序完成编译并开始运行以后，通过修改内存中的指令来插入 Trace 代码，以达到追踪的功能。可见，动态仪表的方式十分灵活。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;本文介绍的 Ftrace，属于静态仪表类型的 Trace 工具。
</div>

<h2 class="title">Ftrace</h2>
<div class="div_learning_post">
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;Ftrace 是一种内核原生的追踪工具。由 Steven Rostedt 开发 <cite>book_system_performance</cite>，并且在内核版本 2.6.27 (2008) 年的时候加入内核主线。Ftrace 的基本结构如下所示:

  <div align="center">
    <img src="./pic/ftrace_arch.png" width=600px>
  </div>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;如上所示是 Ftrace 的基本结构，我们可以看到在内核中有 Ftrace 的 Profiler 和 Tracer 在工作，我们在下文中将分别介绍它们的功能，以及具体操作手段。
</div>

<h2 class="title">tracefs 文件系统</h2>
<div class="div_learning_post">
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;使用 Ftrace 工具的接口是 <code>tracefs</code> 文件系统。它应该被 mount 在以下位置:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@zobin-ubuntu-devbox:/home/zobin<span class="comment"># mount -t tracefs</span></span><br><span class="line">tracefs on /sys/kernel/tracing <span class="built_in">type</span> tracefs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line"></span><br><span class="line">root@zobin-ubuntu-devbox:/home/zobin<span class="comment"># ls /sys/kernel/tracing/</span></span><br><span class="line">available_events            dyn_ftrace_total_info     kprobe_events    saved_cmdlines_size     set_ftrace_pid      timestamp_mode    tracing_cpumask</span><br><span class="line">available_filter_functions  enabled_functions         kprobe_profile   saved_tgids             set_graph_function  trace             tracing_max_latency</span><br><span class="line">available_tracers           error_log                 max_graph_depth  set_event               set_graph_notrace   trace_clock       tracing_on</span><br><span class="line">buffer_percent              events                    options          set_event_notrace_pid   snapshot            trace_marker      tracing_thresh</span><br><span class="line">buffer_size_kb              free_buffer               per_cpu          set_event_pid           stack_max_size      trace_marker_raw  uprobe_events</span><br><span class="line">buffer_total_size_kb        function_profile_enabled  printk_formats   set_ftrace_filter       stack_trace         trace_options     uprobe_profile</span><br><span class="line">current_tracer              hwlat_detector            README           set_ftrace_notrace      stack_trace_filter  trace_pipe</span><br><span class="line">dynamic_events              instances                 saved_cmdlines   set_ftrace_notrace_pid  synthetic_events    trace_stat</span><br></pre></td></tr></table></figure>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;Ftrace 在历史上曾经使用过 <code>debugfs</code>  文件系统接口来进行操作，直到后来独立出来了自己的文件系统。但是 <code>debugfs</code> 文件系统仍然保留了 Ftrace 的入口 (i.e. 以一个子文件夹的形式存在)，具体在如下位置:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@zobin-ubuntu-devbox:/home/zobin<span class="comment"># mount -t debugfs</span></span><br><span class="line">debugfs on /sys/kernel/debug <span class="built_in">type</span> debugfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line"></span><br><span class="line">root@zobin-ubuntu-devbox:/home/zobin<span class="comment"># ls /sys/kernel/debug/tracing/</span></span><br><span class="line">available_events            dyn_ftrace_total_info     kprobe_events    saved_cmdlines_size     set_ftrace_pid      timestamp_mode    tracing_cpumask</span><br><span class="line">available_filter_functions  enabled_functions         kprobe_profile   saved_tgids             set_graph_function  trace             tracing_max_latency</span><br><span class="line">available_tracers           error_log                 max_graph_depth  set_event               set_graph_notrace   trace_clock       tracing_on</span><br><span class="line">buffer_percent              events                    options          set_event_notrace_pid   snapshot            trace_marker      tracing_thresh</span><br><span class="line">buffer_size_kb              free_buffer               per_cpu          set_event_pid           stack_max_size      trace_marker_raw  uprobe_events</span><br><span class="line">buffer_total_size_kb        function_profile_enabled  printk_formats   set_ftrace_filter       stack_trace         trace_options     uprobe_profile</span><br><span class="line">current_tracer              hwlat_detector            README           set_ftrace_notrace      stack_trace_filter  trace_pipe</span><br><span class="line">dynamic_events              instances                 saved_cmdlines   set_ftrace_notrace_pid  synthetic_events    trace_stat</span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;如上所示，我们可以看到在 <code>tracing</code> 目录下有若干的文件，我们会在下面具体的操作中对这些文件的功能进行解释。
</div>

<h2 class="title">Ftrace Function Profiler</h2>
<div class="div_learning_post">
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;Ftrace Function Profiler 提供了内核函数运行的静态数据，我们可以通过它来找到运行时间较长的内核函数，也即找到系统瓶颈。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;Ftrace Function Profiler 通过在每个内核函数的最开始运行被编译好的 Profiling Call 来实现 Profiling。在 GCC 编译的时候，如果启用了 <code>-pg</code> 选项，则编译器会自动地在函数最开始处插入 <code>mcount()</code> 调用。从 GCC 4.6 版本以来，插入的调用则变为 <code>__fentry__()</code>。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;下面我们尝试对部分函数进行 Profiling。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;我们首先确认一下 Ftrace 的初始化状态:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@zobin-ubuntu-devbox:/sys/kernel/debug/tracing<span class="comment"># cat set_ftrace_filter </span></span><br><span class="line"><span class="comment">#### all functions enabled ####</span></span><br><span class="line">root@zobin-ubuntu-devbox:/sys/kernel/debug/tracing<span class="comment"># cat function_profile_enabled </span></span><br><span class="line">0</span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;然后我们运行如下脚本:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;tcp*&#x27;</span> &gt; set_ftrace_filter</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; function_profile_enabled</span><br><span class="line">sleep 10</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; function_profile_enabled</span><br><span class="line"><span class="built_in">echo</span> &gt; set_ftrace_filter</span><br></pre></td></tr></table></figure>

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;然后我们对输出进行观察:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">root@zobin-ubuntu-devbox:/sys/kernel/debug/tracing<span class="comment"># head trace_stat/function*</span></span><br><span class="line">==&gt; trace_stat/function0 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function1 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line">  tcp_recvmsg                              1    4.045 us        4.045 us        0.000 us    </span><br><span class="line">  tcp_recvmsg_locked                       1    3.252 us        3.252 us        0.000 us    </span><br><span class="line">  tcp_write_timer                          1    2.408 us        2.408 us        0.000 us    </span><br><span class="line">  tcp_poll                                 2    1.313 us        0.656 us        0.068 us    </span><br><span class="line">  tcp_write_timer_handler                  1    1.020 us        1.020 us        0.000 us    </span><br><span class="line">  tcp_rcv_space_adjust                     1    0.467 us        0.467 us        0.000 us    </span><br><span class="line">  tcp_release_cb                           1    0.348 us        0.348 us        0.000 us    </span><br><span class="line">  tcp_stream_memory_free                   2    0.320 us        0.160 us        0.000 us    </span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function10 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function11 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line">  tcp_sendmsg                              3    230.274 us      76.758 us       539.782 us  </span><br><span class="line">  tcp_sendmsg_locked                       3    198.174 us      66.058 us       445.199 us  </span><br><span class="line">  tcp_push                                 3    144.392 us      48.130 us       61.359 us   </span><br><span class="line">  tcp_write_xmit                           3    142.835 us      47.611 us       59.649 us   </span><br><span class="line">  tcp_v4_do_rcv                            6    88.430 us       14.738 us       56.166 us   </span><br><span class="line">  tcp_rcv_established                      6    85.988 us       14.331 us       54.772 us   </span><br><span class="line">  tcp_v4_rcv                               6    81.338 us       13.556 us       163.050 us  </span><br><span class="line">  tcp_data_ready                           3    36.735 us       12.245 us       7.659 us    </span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function12 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function13 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function14 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function15 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function16 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line">  tcp_wfree                                3    5.223 us        1.741 us        0.201 us    </span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function17 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function18 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function19 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function2 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function20 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function21 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function22 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function23 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function3 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line">  tcp_v4_rcv                               7    271.222 us      38.746 us       908.842 us  </span><br><span class="line">  tcp_v4_do_rcv                            7    245.733 us      35.104 us       850.498 us  </span><br><span class="line">  tcp_rcv_established                      7    241.681 us      34.525 us       841.727 us  </span><br><span class="line">  tcp_send_ack                             2    96.244 us       48.122 us       2.590 us    </span><br><span class="line">  tcp_data_queue                           6    86.503 us       14.417 us       112.886 us  </span><br><span class="line">  tcp_data_ready                           4    74.480 us       18.620 us       1.477 us    </span><br><span class="line">  tcp_ack                                  7    29.204 us       4.172 us        19.283 us   </span><br><span class="line">  tcp_v4_early_demux                       7    17.127 us       2.446 us        0.639 us    </span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function4 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function5 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function6 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line">  tcp_sendmsg                              7    554.454 us      79.207 us       419.218 us  </span><br><span class="line">  tcp_sendmsg_locked                       7    508.787 us      72.683 us       269.840 us  </span><br><span class="line">  tcp_push                                 7    441.902 us      63.128 us       233.553 us  </span><br><span class="line">  tcp_write_xmit                           7    436.902 us      62.414 us       229.824 us  </span><br><span class="line">  tcp_v4_do_rcv                            8    198.514 us      24.814 us       337.225 us  </span><br><span class="line">  tcp_rcv_established                      8    195.133 us      24.391 us       333.934 us  </span><br><span class="line">  tcp_v4_rcv                               8    190.304 us      23.788 us       559.113 us  </span><br><span class="line">  tcp_data_queue                           4    128.238 us      32.059 us       133.134 us  </span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function7 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function8 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line"></span><br><span class="line">==&gt; trace_stat/function9 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line">  tcp_orphan_update                        6    23.298 us       3.883 us        2.978 us    </span><br><span class="line">  tcp_orphan_count_sum                     6    7.929 us        1.321 us        0.189 us    </span><br><span class="line">  tcp_write_timer                          1    2.172 us        2.172 us        0.000 us    </span><br><span class="line">  tcp_write_timer_handler                  1    0.828 us        0.828 us        0.000 us    </span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;可以观察到在 <code>trace_stat</code> 下有多个文件的输出，输出格式是 <code>functionX</code>，其中 <code>X</code> 代表的是 CPU 的核心编号。我们在上面看到一共有 24 个文件输出，因为我们做实验的平台是一个 24 核心的平台。在输出的数据中，我们可以看到函数名称 (<code>Function</code>)、调用次数 (<code>Hit</code>)、各个函数的总运行时间 (<code>Time</code>)、各个函数的平均每次调用的运行时间 (<code>Avg</code>)，以及运行时间的标准差 (<code>s^2</code>)。
</div>

<h2 class="title">Ftrace Function Tracer</h2>
<div class="div_learning_post">
  <div align="center">
    <img src="./pic/ftrace_tracer.png" width=600px>
  </div>

  <h3 class="title">使用 <code>trace</code></h3>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;下面我们基于 <code>trace</code> 文件进行 Tracing。

  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;首先我们确认一下 Ftrace Tracer 的初始化状态:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@zobin-ubuntu-devbox:/sys/kernel/debug/tracing<span class="comment"># cat set_ftrace_filter </span></span><br><span class="line"><span class="comment">#### all functions enabled ####</span></span><br><span class="line">root@zobin-ubuntu-devbox:/sys/kernel/debug/tracing<span class="comment"># cat current_tracer </span></span><br><span class="line">nop</span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;接着我们运行如下脚本:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; tracing_on</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;*sleep&#x27;</span> &gt; set_ftrace_filter</span><br><span class="line"><span class="built_in">echo</span> <span class="keyword">function</span> &gt; current_tracer</span><br><span class="line">sleep 10</span><br><span class="line">cat trace &gt; /tmp/out.trace01.txt</span><br><span class="line"><span class="built_in">echo</span> nop &gt; current_tracer</span><br><span class="line"><span class="built_in">echo</span> &gt; set_ftrace_filter</span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;然后我们就可以从文件中观察到如下输出:

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@zobin-ubuntu-devbox:/sys/kernel/debug/tracing<span class="comment"># more /tmp/out.trace01.txt </span></span><br><span class="line"><span class="comment"># tracer: function</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 52/52   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                                _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                               / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                              | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                              || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                              ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |         |   ||||      |         |</span></span><br><span class="line">          sleep-5912    [022] ....  2559.449999: __x64_sys_clock_nanosleep &lt;-do_syscall_64</span><br><span class="line">          sleep-5912    [022] ....  2559.450001: common_nsleep &lt;-__x64_sys_clock_nanosleep</span><br><span class="line">          sleep-5912    [022] ....  2559.450002: hrtimer_nanosleep &lt;-common_nsleep</span><br><span class="line">          sleep-5912    [022] ....  2559.450002: do_nanosleep &lt;-hrtimer_nanosleep</span><br><span class="line">            node-5128    [017] ....  2560.118227: __x64_sys_clock_nanosleep &lt;-do_syscall_64</span><br><span class="line">            node-5128    [017] ....  2560.118229: common_nsleep &lt;-__x64_sys_clock_nanosleep</span><br><span class="line">            node-5128    [017] ....  2560.118229: hrtimer_nanosleep &lt;-common_nsleep</span><br><span class="line">            node-5128    [017] ....  2560.118229: do_nanosleep &lt;-hrtimer_nanosleep</span><br><span class="line">          sleep-5925    [007] ....  2560.394063: __x64_sys_clock_nanosleep &lt;-do_syscall_64</span><br><span class="line">          sleep-5925    [007] ....  2560.394064: common_nsleep &lt;-__x64_sys_clock_nanosleep</span><br></pre></td></tr></table></figure>
  <p>
  &nbsp;&nbsp;&nbsp;&nbsp;在上面输出的每一行中，我们可以观察到进程的 PID (<code>PID</code>)、进程名称 (<code>TASK</code>)，运行的 CPU 核心 (<code>CPU#</code>)，运行的时间戳 (<code>TIMESTAMP</code>)，以及函数的调用情况 (<code>FUNCTION</code>)。
</div>

<div class="div_ref" id="ref_container"></div>

</body>
<!--引用其它章节-->
<!-- 
<ref></ref> 
-->

<!--引用文献-->
<!-- 
<cite></cite> 
-->

<!--关键词-->
<!-- 
<def></def> 
-->

<!--醒目注意-->
<!-- 
<note></note> 
-->

<!--表格-->
<!--
<table border="1" align="center" bgcolor="#FFFFFF">
  <caption>表格</caption>
  <tr>
    <th>A</th>
    <th>B</th>
    <th>C</th>
  </tr>
  <tr>
    <td>xxx</td>
    <td>xxx</td>
    <td>xxx</td>
  </tr>
</table>
-->

<!--矩阵公式-->
<!--
<div class="cmath" align="center">
  `((1, 0),(1, 0))`
</div><br>
-->

<!--伪代码-->
<!--
<pre id="quicksort" style="display:hidden;">
  % This quicksort algorithm is extracted from Chapter 7, Introduction to Algorithms (3rd edition)
  \begin{algorithm}
  \caption{Quicksort}
  \begin{algorithmic}
  \PROCEDURE{Quicksort}{$A, p, r$}
      % Add Here

      % 空行
      % \STATE \texttt{\\}
  \ENDPROCEDURE
  \end{algorithmic}
  \end{algorithm}
</pre>
<script>
    pseudocode.renderElement(document.getElementById("quicksort"));
</script>
-->
<!--
Latex 伪代码格式见: https://github.com/SaswatPadhi/pseudocode.js
-->

<!--图片-->
<!--
<div align="center">
  <img src="./pic/xxx.png" width=80%>
</div>
-->

<!--正文-->
<!--
<p>
&nbsp;&nbsp;&nbsp;&nbsp;公式：<span>`\overline{A}\overline{B}`</span>
</p>
-->
      </div>
      
      
      
    </div>
    
  <ul class="breadcrumb">
          
            <li><a href="/sec_learning_backup/">SEC_LEARNING_BACKUP</a></li>
          <li>LINUX_KERNEL_TRACING_FTRACE</li>
        
  </ul>

    
    
    


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zhuobin Huang"
      src="/images/avatar_2.png">
  <p class="site-author-name" itemprop="name">Zhuobin Huang</p>
  <div class="site-description" itemprop="description">System Engineer</div>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zobinHuang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zobinHuang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zobin1999@gmail.com" title="E-Mail → mailto:zobin1999@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhuobin Huang</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
